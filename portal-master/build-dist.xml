<?xml version="1.0"?>

<project basedir="." default="dist" name="portal-dist" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build.xml" />

	<if>
		<isset property="java.security" />
		<then>
			<property name="java.security.manager.option" value="-Djava.security.manager" />
		</then>
		<else>
			<property name="java.security.manager.option" value="" />
		</else>
	</if>

	<macrodef name="build-dist-tomcat-bare" >
		<sequential>
			<if>
				<equals arg1="${tomcat.keep.app.server.properties}" arg2="true" />
				<then>
					<antcall inheritAll="false" target="update-sdk-properties" />

					<antcall inheritAll="false" target="unzip-tomcat" />
				</then>
				<else>
					<app-server-properties-update>
						app.server.type=tomcat
					</app-server-properties-update>

					<antcall inheritAll="false" target="update-sdk-properties" />

					<antcall target="unzip-tomcat" />
				</else>
			</if>

			<delete dir="${project.dir}/portal-web/classes" />
		</sequential>
	</macrodef>

	<macrodef name="download-dynamic-jars">
		<attribute name="app.server.lib.portal.dir" />

		<sequential>
			<property file="${project.dir}/portal-impl/src/portal.properties" prefix="portal" />

			<mirrors-get
				dest="@{app.server.lib.portal.dir}/${portal.setup.liferay.pool.provider.jar.name[hikaricp]}"
				src="${portal.setup.liferay.pool.provider.jar.url[hikaricp]}"
			/>
		</sequential>
	</macrodef>

	<macrodef name="update-jboss-java-opts">
		<sequential>
			<replace
				dir="${app.server.jboss.dir}/bin"
				includes="*.bat,*.conf"
				token="-Xmx512m"
				value="-Xmx1024m"
			/>
		</sequential>
	</macrodef>

	<macrodef name="update-plugins-includes-plugin">
		<attribute name="plugins.includes.plugin.bundle" />
		<attribute name="plugins.includes.plugin.dependent-apps" />
		<attribute name="plugins.includes.plugin.marketplace" />
		<attribute name="plugins.includes.plugin.name" />
		<attribute name="plugins.includes.plugin.public" />

		<sequential>
			<if>
				<and>
					<or>
						<and>
							<equals arg1="${lp.release.type}" arg2="CE" />
							<equals arg1="@{plugins.includes.plugin.public}" arg2="true" />
						</and>
						<equals arg1="${lp.release.type}" arg2="EE" />
					</or>
					<or>
						<and>
							<equals arg1="${plugins.includes.bundle.required}" arg2="true" />
							<equals arg1="@{plugins.includes.plugin.bundle}" arg2="true" />
						</and>
						<and>
							<equals arg1="${plugins.includes.marketplace.required}" arg2="true" />
							<equals arg1="@{plugins.includes.plugin.marketplace}" arg2="true" />
						</and>
					</or>
				</and>
				<then>
					<echo append="true" file="${lp.plugins.dir}/build.${user.name}.properties">@{plugins.includes.plugin.dependent-apps},@{plugins.includes.plugin.name},</echo>
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="build-dist-glassfish">
		<app-server-properties-update>
			app.server.type=glassfish
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall target="unzip-glassfish" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.glassfish.deploy.dir}" />
			<param name="deployer.app.server.type" value="glassfish" />
			<param name="deployer.app.server.lib.portal.dir" value="lib/portal" />
		</antcall>
	</target>

	<target name="build-dist-jboss">
		<app-server-properties-update>
			app.server.type=jboss
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall inheritAll="false" target="unzip-jboss" />

		<update-jboss-java-opts />

		<delete dir="${project.dir}/portal-web/classes" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.jboss.deploy.dir}" />
			<param name="deployer.app.server.type" value="jboss" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.jboss.portal.dir}/WEB-INF/lib" />
		</antcall>
	</target>

	<target name="build-dist-jetty">
		<app-server-properties-update>
			app.server.type=jetty
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall target="unzip-jetty" />

		<delete dir="${project.dir}/portal-web/classes" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.jetty.deploy.dir}" />
			<param name="deployer.app.server.type" value="jetty" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.jetty.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-jonas">
		<antcall target="unzip-jonas" />

		<app-server-properties-update>
			app.server.type=jonas
		</app-server-properties-update>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.jonas.deploy.dir}" />
			<param name="deployer.app.server.type" value="jonas" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.jonas.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-language-hook">
		<if>
			<available file="${lp.plugins.dir}/hooks/liferay-language-${locale.current}-hook" />
			<then>
				<delete dir="${lp.plugins.dir}/hooks/liferay-language-${locale.current}-hook" />
			</then>
		</if>

		<exec dir="${lp.plugins.dir}/hooks" executable="cmd.exe">
			<arg line="/c create.bat liferay-language-${locale.current} &quot;Liferay Portal Language Pack ${locale.current}&quot;" />
		</exec>

		<echo file="${lp.plugins.dir}/hooks/liferay-language-${locale.current}-hook/docroot/WEB-INF/liferay-hook.xml"><![CDATA[<?xml version="1.0"?>
<!DOCTYPE hook PUBLIC "-//Liferay//DTD Hook 6.1.0//EN" "http://www.liferay.com/dtd/liferay-hook_6_1_0.dtd">

<hook>
	<language-properties>content/Language-ext_${locale.current}.properties</language-properties>
</hook>]]></echo>

		<copy file="portal-impl/src/content/Language_${locale.current}.properties" tofile="${lp.plugins.dir}/hooks/liferay-language-${locale.current}-hook/docroot/WEB-INF/src/content/Language-ext_${locale.current}.properties" />

		<if>
			<not>
				<equals arg1="${lp.plugins.minor.version}" arg2="1" />
			</not>
			<then>
				<replace file="${lp.plugins.dir}/hooks/liferay-language-${locale.current}-hook/docroot/WEB-INF/liferay-plugin-package.properties">
					<replacefilter token="module-incremental-version=1" value="module-incremental-version=${lp.plugins.minor.version}" />
				</replace>
			</then>
		</if>

		<ant dir="${lp.plugins.dir}/hooks/liferay-language-${locale.current}-hook" inheritAll="false" target="war" />
	</target>

	<target name="build-dist-language-hooks">
		<exec executable="cmd">
			<arg line="/c dir /b ${project.dir}\portal-impl\src\content\ > ${project.dir}\output.txt" />
		</exec>

		<loadfile property="output.txt.content" srcFile="${project.dir}\output.txt" />

		<delete file="output.txt" />

		<beanshell>
			String outputTxtContent = project.getProperty("output.txt.content");

			if (outputTxtContent.contains("File Not Found")) {
				outputTxtContent = "";
			}

			String locales = outputTxtContent.replaceAll("\r\n", ",");

			locales = locales.replaceAll("Language.properties,", "");
			locales = locales.replaceAll("Language_", "");
			locales = locales.replaceAll(".properties", "");

			if (locales.endsWith(",")) {
				locales = locales.substring(0, locales.length() - 1);
			}

			project.setProperty("locale.list", locales);
		</beanshell>

		<for list="${locale.list}" param="locale.current">
			<sequential>
				<antcall target="build-dist-language-hook">
					<param name="locale.current" value="@{locale.current}" />
				</antcall>
			</sequential>
		</for>
	</target>

	<target name="build-dist-plugins">
		<antcall inheritAll="false" target="update-plugins-includes">
			<param name="plugins.includes.bundle.required" value="true" />
		</antcall>

		<ant dir="${lp.plugins.dir}" inheritAll="false" target="all" />
	</target>

	<target name="build-dist-resin">
		<app-server-properties-update>
			app.server.type=resin
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall target="unzip-resin" />

		<delete dir="${project.dir}/portal-web/classes" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.resin.deploy.dir}" />
			<param name="deployer.app.server.type" value="resin" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.resin.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-sql-oracle">
		<ant dir="sql" inheritAll="false" target="rebuild-oracle" />
		<ant dir="sql" inheritAll="false" target="export-oracle" />

		<move file="sql/lportal.dmp" tofile="dist/liferay-portal-sql-oracle-${lp.version}.dmp" />
	</target>

	<target name="build-dist-tcat">
		<app-server-properties-update>
			app.server.type=tomcat
			app.server.tomcat.version=7.0.39
			app.server.tomcat.zip.url=http://archive.apache.org/dist/tomcat/tomcat-7/v7.0.39/bin/apache-tomcat-7.0.39.zip
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall inheritAll="false" target="build-dist-tomcat">
			<param name="tomcat.keep.app.server.properties" value="true" />
		</antcall>

		<beanshell>
			String lpVersion = project.getProperty("lp.version");

			String lpVersionTcat = lpVersion.replace(".", "_");

			project.setProperty("lp.version.tcat", lpVersionTcat);
		</beanshell>

		<echo append="true" file="release.${user.name}.properties">
			lp.version.tcat=${lp.version.tcat}
		</echo>

		<delete dir="${app.server.tcat.dir}" />

		<antcall inheritAll="false" target="build-dist-tcat-profile">
			<param name="app.server.tcat.dir" value="${app.server.tcat.dir}" />
		</antcall>

		<antcall inheritAll="false" target="build-dist-tcat-tomcat">
			<param name="app.server.tcat.dir" value="${app.server.tcat.dir}" />
		</antcall>

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.tcat.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.tcat.zip.name}"
					src="${app.server.tcat.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<antcall inheritAll="false" target="build-dist-tcat-admin">
			<param name="app.server.tcat.dir" value="${app.server.tcat.dir}" />
			<param name="app.server.tcat.zip.name" value="${app.server.tcat.zip.name}" />
		</antcall>

		<antcall inheritAll="false" target="build-dist-tcat-agent">
			<param name="app.server.tcat.dir" value="${app.server.tcat.dir}" />
			<param name="app.server.tcat.zip.name" value="${app.server.tcat.zip.name}" />
		</antcall>

		<app-server-properties-reset />
	</target>

	<target name="build-dist-tcat-admin">
		<copy file="tools/servers/tcat/tcat-init.groovy" todir="${app.server.tcat.dir}/admin" />

		<unzip
			dest="${app.server.tcat.dir}/admin/webapps"
			src="${app.server.parent.dir}/${app.server.tcat.zip.name}"
		>
			<patternset
				includes="**/console.war"
			/>
			<flattenmapper />
		</unzip>

		<replace file="${app.server.tcat.dir}/admin/conf/server.xml">
			<replacefilter token="8005" value="8105" />
			<replacefilter token="8009" value="8109" />
			<replacefilter token="8080" value="8180" />
			<replacefilter token="8443" value="81443" />
		</replace>

		<mkdir dir="${app.server.tcat.dir}/admin/tcat_init/profiles" />

		<copy file="dist/liferay-portal-tcat-profile-${lp.version}.zip" todir="${app.server.tcat.dir}/admin/tcat_init/profiles" />

		<mkdir dir="${app.server.tcat.dir}/admin/tcat_init/scripts" />

		<copy file="tools/servers/tcat/LiferayDeployerFactory.groovy" todir="${app.server.tcat.dir}/admin/tcat_init/scripts" />

		<antcall target="build-dist-tcat-admin-webapps-plugins">
			<param name="app.server.tcat.dir" value="${app.server.tcat.dir}" />
		</antcall>

		<antcall target="build-dist-tcat-admin-webapps-portal">
			<param name="app.server.tcat.dir" value="${app.server.tcat.dir}" />
		</antcall>
	</target>

	<target name="build-dist-tcat-admin-webapps-plugins">
		<echo append="true" file="${lp.plugins.dir}/build.${user.name}.properties">
			plugins.war.excludes=**/WEB-INF/service/**,**/WEB-INF/src/**
		</echo>

		<ant dir="${lp.plugins.dir}" inheritAll="false" target="all" />

		<copy todir="${app.server.tcat.dir}/admin/tcat_init/webapps/${lp.version.tcat}">
			<fileset dir="${lp.plugins.dir}/dist" includes="*.war" />
		</copy>
	</target>

	<target name="build-dist-tcat-admin-webapps-portal">
		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<mkdir dir="${tstamp.value}/META-INF" />

		<echo file="${tstamp.value}/META-INF/context.xml"><![CDATA[<?xml version="1.0"?>
			<Context crossContext="true" path="">
				<Realm
					className="org.apache.catalina.realm.JAASRealm"
					appName="PortalRealm"
					userClassNames="com.liferay.portal.kernel.security.jaas.PortalPrincipal"
					roleClassNames="com.liferay.portal.kernel.security.jaas.PortalRole"
				/>
			</Context>]]>
		</echo>

		<mkdir dir="${app.server.tcat.dir}/admin/tcat_init/webapps/${lp.version.tcat}" />

		<copy file="dist/liferay-portal-${lp.version}.war" tofile="${app.server.tcat.dir}/admin/tcat_init/webapps/${lp.version.tcat}/ROOT.war" />

		<zip
			basedir="${tstamp.value}"
			destfile="${app.server.tcat.dir}/admin/tcat_init/webapps/${lp.version.tcat}/ROOT.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="build-dist-tcat-agent">
		<echo file="${app.server.tcat.dir}/agent/conf/Catalina/localhost/agent.xml"><![CDATA[<?xml version="1.0"?>
			<Context privileged="true" />]]>
		</echo>

		<unzip
			dest="${app.server.tcat.dir}/agent/webapps"
			src="${app.server.parent.dir}/${app.server.tcat.zip.name}"
		>
			<patternset
				includes="**/agent.war"
			/>
			<flattenmapper />
		</unzip>
	</target>

	<target name="build-dist-tcat-profile">
		<mkdir dir="${app.server.tcat.dir}/profile/files/lib/ext" />

		<copy file="tools/servers/tcat/profile.xml" todir="${app.server.tcat.dir}/profile">
			<filterset>
				<filter token="lp.version" value="${lp.version}" />
			</filterset>
		</copy>

		<copy todir="${app.server.tcat.dir}/profile/files/lib/ext">
			<fileset dir="${app.server.tomcat.dir}/lib/ext" />
		</copy>

		<echo file="${app.server.tcat.dir}/profile/files/lib/ext/portal-bundle.properties">auto.deploy.deploy.dir=${catalina.base}/deploy</echo>

		<delete failonerror="false" file="dist/liferay-portal-tcat-profile-${lp.version}.zip" />

		<zip destfile="dist/liferay-portal-tcat-profile-${lp.version}.zip">
			<zipfileset
				dir="${app.server.tcat.dir}/profile"
			/>
		</zip>
	</target>

	<target name="build-dist-tcat-tomcat">
		<mkdir dir="${app.server.tcat.dir}/tomcat" />

		<copy todir="${app.server.tcat.dir}/tomcat">
			<fileset
				dir="${app.server.tomcat.dir}"
				excludes="**/ROOT.xml,logs/**,temp/**,webapps/**,work/**"
			/>
		</copy>

		<mkdir dir="${app.server.tcat.dir}/tomcat/temp" />

		<replace file="${app.server.tcat.dir}/tomcat/conf/server.xml">
			<replacetoken><![CDATA[xmlValidation="false" deployXML="false" xmlNamespaceAware="false">]]></replacetoken>
			<replacevalue><![CDATA[xmlValidation="false" xmlNamespaceAware="false">]]></replacevalue>
		</replace>

		<move file="${app.server.tcat.dir}/tomcat" tofile="${app.server.tcat.dir}/admin" />

		<copy todir="${app.server.tcat.dir}/agent">
			<fileset dir="${app.server.tcat.dir}/admin" />
		</copy>
	</target>

	<target name="build-dist-tcserver">
		<app-server-properties-update>
			app.server.type=tcserver
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall target="unzip-tcserver" />

		<delete dir="${project.dir}/portal-web/classes" />

		<antcall inheritAll="false" target="all" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.tcserver.deploy.dir}" />
			<param name="deployer.app.server.type" value="tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.tcserver.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-tomcat">
		<build-dist-tomcat-bare />

		<ant inheritAll="false" target="deploy" />

		<if>
			<not>
				<equals arg1="${tomcat.keep.app.server.properties}" arg2="true" />
			</not>
			<then>
				<app-server-properties-reset />
			</then>
		</if>

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.parent.dir}/tomcat-${app.server.tomcat.version}/webapps" />
			<param name="deployer.app.server.type" value="tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.parent.dir}/tomcat-${app.server.tomcat.version}/webapps/ROOT/WEB-INF/lib" />
		</antcall>
	</target>

	<target name="build-dist-tomcat-bare">
		<build-dist-tomcat-bare />
	</target>

	<target name="build-dist-weblogic">
		<app-server-properties-update>
			app.server.type=weblogic
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall target="unzip-weblogic" />

		<delete dir="${project.dir}/portal-web/classes" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.weblogic.deploy.dir}" />
			<param name="deployer.app.server.type" value="weblogic" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.weblogic.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-websphere">
		<app-server-properties-update>
			app.server.type=websphere
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall inheritAll="false" target="unzip-websphere" />

		<delete dir="${project.dir}/portal-web/classes" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.websphere.deploy.dir}" />
			<param name="deployer.app.server.type" value="websphere" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.websphere.portal.dir}/WEB-INF/lib" />
		</antcall>
	</target>

	<target name="build-dist-wildfly">
		<app-server-properties-update>
			app.server.type=wildfly
		</app-server-properties-update>

		<antcall inheritAll="false" target="update-sdk-properties" />

		<antcall target="unzip-wildfly" />

		<delete dir="${project.dir}/portal-web/classes" />

		<ant inheritAll="false" target="deploy" />

		<antcall inheritAll="false" target="resolve-dynamic-jars" />

		<app-server-properties-reset />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.parent.dir}/wildfly-${app.server.wildfly.version}/standalone/deployments" />
			<param name="deployer.app.server.type" value="wildfly" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.parent.dir}/wildfly-${app.server.wildfly.version}/standalone/deployments/ROOT.war/WEB-INF/lib" />
		</antcall>
	</target>

	<target name="deploy-plugins">
		<delete failonerror="false" includeemptydirs="true">
			<fileset
				dir="${deployer.dest.dir}"
				includes="*-ext/**,*-hook/**,*-layouttpl/**,*-portlet/**,*-theme/**"
			/>
		</delete>

		<java
			classname="com.liferay.portal.tools.deploy.ExtDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-ext-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-bridges/util-bridges.jar" />
			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>

		<java
			classname="com.liferay.portal.tools.deploy.HookDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-hook-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-bridges/util-bridges.jar" />
			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>

		<java
			classname="com.liferay.portal.tools.deploy.LayoutTemplateDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-layouttpl-*.war" />

			<!-- Dependent Libraries -->

			<arg value="util-bridges/util-bridges.jar" />
			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>

		<java
			classname="com.liferay.portal.tools.deploy.PortletDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.aui.taglib.dtd=util-taglib/classes/META-INF/liferay-aui.tld" />
			<jvmarg value="-Ddeployer.portlet.taglib.dtd=util-taglib/classes/META-INF/liferay-portlet.tld" />
			<jvmarg value="-Ddeployer.portlet-ext.taglib.dtd=util-taglib/classes/META-INF/liferay-portlet-ext.tld" />
			<jvmarg value="-Ddeployer.security.taglib.dtd=util-taglib/classes/META-INF/liferay-security.tld" />
			<jvmarg value="-Ddeployer.theme.taglib.dtd=util-taglib/classes/META-INF/liferay-theme.tld" />
			<jvmarg value="-Ddeployer.ui.taglib.dtd=util-taglib/classes/META-INF/liferay-ui.tld" />
			<jvmarg value="-Ddeployer.util.taglib.dtd=util-taglib/classes/META-INF/liferay-util.tld" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-portlet-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-bridges/util-bridges.jar" />
			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>

		<java
			classname="com.liferay.portal.tools.deploy.ThemeDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.theme.taglib.dtd=util-taglib/classes/META-INF/liferay-theme.tld" />
			<jvmarg value="-Ddeployer.util.taglib.dtd=util-taglib/classes/META-INF/liferay-util.tld" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-theme-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-bridges/util-bridges.jar" />
			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>

		<java
			classname="com.liferay.portal.tools.deploy.WebDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-web-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-bridges/util-bridges.jar" />
			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>
	</target>

	<target name="dist">
		<if>
			<available file="${patching.tool.source.dir}" type="dir" />
			<then>
				<ant dir="${patching.tool.source.dir}" inheritAll="false" target="all" />
			</then>
		</if>

		<exec dir="${project.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn --username ${svn.username} --password ${svn.password} update -r ${svn.revision}" />
		</exec>

		<exec dir="${lp.source.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn --username ${svn.username} --password ${svn.password} update -r ${svn.revision}" />
		</exec>

		<exec dir="${lp.plugins.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn --username ${svn.username} --password ${svn.password} update -r ${svn.revision}" />
		</exec>

		<antcall target="all" />

		<delete dir="${lp.plugins.dir}/dist" />

		<delete dir="${liferay.home}/data" />
		<delete dir="${liferay.home}/deploy" />
		<delete dir="${liferay.home}/logs" />

		<antcall target="doc" />

		<remake-dir dir="dist" />

		<remake-dir dir="tools/zip_tmpl/license" />

		<copy file="copyright.txt" todir="tools/zip_tmpl/license" />
		<copy file="lib/versions.html" todir="tools/zip_tmpl/license" />
		<copy file="readme.markdown" todir="tools/zip_tmpl" />

		<antcall target="zip-portal-war" />

		<antcall target="build-dist-plugins" />

		<antcall target="build-dist-glassfish" />
		<antcall target="build-dist-jboss" />
		<antcall target="build-dist-jetty" />
		<antcall target="build-dist-jonas" />
		<antcall target="build-dist-resin" />
		<antcall target="build-dist-tcat" />
		<antcall target="build-dist-tomcat" />
		<antcall target="build-dist-wildfly" />

		<antcall target="zip-glassfish" />
		<antcall target="zip-jboss" />
		<antcall target="zip-jetty" />
		<antcall target="zip-jonas" />
		<antcall target="zip-patching-tool" />
		<antcall target="zip-portal-client" />
		<antcall target="zip-portal-dependencies" />
		<antcall target="zip-resin" />
		<antcall target="zip-sql" />
		<antcall target="zip-src" />
		<antcall target="zip-tcat" />
		<antcall target="zip-tomcat" />
		<antcall target="zip-wildfly" />

		<ant antfile="build-maven.xml" inheritAll="false" target="zip-maven" />

		<!--<antcall target="build-dist-sql-oracle" />-->

		<ant dir="${lp.plugins.dir}" inheritAll="false" target="extract-plugins-sdk" />

		<move file="${lp.plugins.dir}/dist/liferay-plugins-sdk-${lp.version}.zip" tofile="dist/liferay-plugins-sdk-${lp.version}.zip" />

		<antcall target="update-plugins-includes">
			<param name="plugins.includes.marketplace.required" value="true" />
		</antcall>

		<ant dir="${lp.plugins.dir}" inheritAll="false" target="all" />

		<if>
			<isset property="dist.username" />
			<then>
				<scp todir="${dist.username}:${dist.password}@${dist.host}:/home/${dist.username}" trust="yes">
					<fileset dir="dist" />
				</scp>
			</then>
		</if>

		<echo>Manually run "ant -buildfile build-maven.xml deploy-release-artifacts" if the
release was successful.</echo>
	</target>

	<target name="exec-patching-tool">
		<if>
			<os family="unix" />
			<then>
				<exec dir="${patching.tool.dir}" executable="sh">
					<arg line="patching-tool.sh ${patching.tool.arg.line}" />
				</exec>
			</then>
			<else>
				<exec dir="${patching.tool.dir}" executable="cmd.exe">
					<arg line="/c patching-tool.bat ${patching.tool.arg.line}" />
				</exec>
			</else>
		</if>
	</target>

	<target name="prepare-generated-files">
		<antcall target="clean" />
		<antcall target="start" />

		<record action="start" name="prepare-generated-files.txt" />

		<ant dir="portal-impl" inheritAll="false" target="build-iw" />
		<ant dir="portal-impl" inheritAll="false" target="build-lib-versions" />
		<ant dir="portal-impl" inheritAll="false" target="build-services" />
		<ant dir="portal-impl" inheritAll="false" target="build-wsdds" />

		<delete file="portal-impl/classes/META-INF/javadocs-all.xml" />
		<delete file="portal-impl/classes/META-INF/javadocs-rt.xml" />
		<delete file="portal-impl/src/META-INF/javadocs-all.xml" />
		<delete file="portal-impl/src/META-INF/javadocs-rt.xml" />

		<ant dir="portal-impl" inheritall="false" target="compile-test" />

		<ant inheritall="false" target="format-javadoc">
			<property name="generate.xml" value="true" />
		</ant>

		<delete>
			<fileset dir="${lp.plugins.dir}" includes="**/javadocs-all.xml,**/javadocs-rt.xml" />
		</delete>

		<antcall target="deploy" />

		<ant dir="${lp.plugins.dir}" inheritall="false" target="clean" />
		<ant dir="${lp.plugins.dir}" inheritall="false" target="compile" />

		<ant dir="${lp.plugins.dir}" inheritall="false" target="format-javadoc">
			<property name="generate.xml" value="true" />
		</ant>

		<parallel>
			<if>
				<os family="windows" />
				<then>
					<exec executable="cmd">
						<arg line="/c ${app.server.tomcat.bin.dir}/catalina run" />
					</exec>
				</then>
				<else>
					<exec executable="${app.server.tomcat.bin.dir}/catalina.sh">
						<arg line="run" />
					</exec>
				</else>
			</if>

			<sequential>
				<waitfor>
					<http url="http://localhost:8080" />
				</waitfor>

				<ant dir="portal-client" inheritAll="false" target="build-client" />

				<if>
					<os family="windows" />
					<then>
						<exec executable="cmd">
							<arg line="/c ${app.server.tomcat.bin.dir}/shutdown.bat" />
						</exec>
					</then>
					<else>
						<exec executable="${app.server.tomcat.bin.dir}/shutdown.sh" />
					</else>
				</if>
			</sequential>
		</parallel>

		<beanshell>
			project.setProperty("prepare-generated-files.tstamp", String.valueOf(System.currentTimeMillis()));
		</beanshell>

		<record action="stop" name="prepare-generated-files.txt" />

		<if>
			<resourcecontains resource="prepare-generated-files.txt" substring="java.lang.RuntimeException" />
			<then>
				<delete file="prepare-generated-files.txt" />

				<fail>Aborting due to Java exception.</fail>
			</then>
		</if>

		<delete file="prepare-generated-files.txt" />

		<echo file="prepare-generated-files.tstamp">${prepare-generated-files.tstamp}</echo>
	</target>

	<target name="resolve-dynamic-jars">
		<sequential>
			<if>
				<equals arg1="${app.server.type}" arg2="glassfish" />
				<then>
					<tstamp>
						<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
					</tstamp>

					<unzip
						dest="${app.server.glassfish.deploy.dir}/${tstamp.value}"
						src="${app.server.glassfish.deploy.dir}/liferay-portal.war"
					/>

					<download-dynamic-jars
						app.server.lib.portal.dir="${app.server.glassfish.deploy.dir}/${tstamp.value}/WEB-INF/lib"
					/>

					<zip
						basedir="${app.server.glassfish.deploy.dir}/${tstamp.value}"
						destfile="${app.server.glassfish.deploy.dir}/liferay-portal.war"
					/>

					<delete dir="${app.server.glassfish.deploy.dir}/${tstamp.value}" />
				</then>
				<else>
					<download-dynamic-jars
						app.server.lib.portal.dir="${app.server.lib.portal.dir}"
					/>
				</else>
			</if>
		</sequential>
	</target>

	<target name="unzip-glassfish">
		<delete dir="${app.server.glassfish.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.glassfish.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.glassfish.zip.name}"
					src="${app.server.glassfish.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<unzip
			 dest="${app.server.parent.dir}"
			 src="${app.server.parent.dir}/${app.server.glassfish.zip.name}"
		>
			<patternset
				includes="glassfish3/glassfish/**,glassfishv3/glassfish/**"
			/>
			<mapper
				type="regexp"
				from="glassfishv?3/glassfish/(.*)"
				to="${app.server.glassfish.dir}/\1"
			/>
		</unzip>

		<if>
			<equals arg1="${app.server.glassfish.version}" arg2="3.1.2.2" />
			<then>

				<!-- GLASSFISH-19008 -->

				<zip
					basedir="tools/servers/glassfish/patches/GLASSFISH-19008/classes"
					destfile="${app.server.glassfish.dir}/modules/web-core.jar"
					update="yes"
				/>
			</then>
		</if>

		<if>
			<equals arg1="${java.security.manager.option}" arg2="" />
			<then>
				<replace file="${app.server.glassfish.instance.dir}/config/domain.xml">
					<replacetoken><![CDATA[<jvm-options>-Xmx512m</jvm-options>]]></replacetoken>
					<replacevalue>
						<![CDATA[
							<jvm-options>-Dfile.encoding=UTF8</jvm-options>
							<jvm-options>-Djava.net.preferIPv4Stack=true</jvm-options>
							<jvm-options>-Dorg.apache.catalina.loader.WebappClassLoader.ENABLE_CLEAR_REFERENCES=false</jvm-options>
							<jvm-options>-Duser.timezone=GMT</jvm-options>
							<jvm-options>-Xmx1024m</jvm-options>
						]]>
					</replacevalue>
				</replace>
			</then>
			<else>
				<replace file="${app.server.glassfish.instance.dir}/config/domain.xml">
					<replacefilter token="@java.security.manager.option@" value="${java.security.manager.option}" />
					<replacetoken><![CDATA[<jvm-options>-Xmx512m</jvm-options>]]></replacetoken>
					<replacevalue>
						<![CDATA[
							<jvm-options>-Dfile.encoding=UTF8</jvm-options>
							<jvm-options>-Djava.net.preferIPv4Stack=true</jvm-options>
							<jvm-options>@java.security.manager.option@</jvm-options>
							<jvm-options>-Dorg.apache.catalina.loader.WebappClassLoader.ENABLE_CLEAR_REFERENCES=false</jvm-options>
							<jvm-options>-Duser.timezone=GMT</jvm-options>
							<jvm-options>-Xmx1024m</jvm-options>
						]]>
					</replacevalue>
				</replace>
			</else>
		</if>

		<replace file="${app.server.glassfish.instance.dir}/config/domain.xml">
			<replacetoken><![CDATA[<jvm-options>-XX:MaxPermSize=192m</jvm-options>]]></replacetoken>
			<replacevalue><![CDATA[<jvm-options>-XX:MaxPermSize=512m</jvm-options>]]></replacevalue>
		</replace>

		<echo file="${app.server.glassfish.instance.dir}/config/server.policy">
			grant {
				permission java.security.AllPermission;
			};
		</echo>

		<chmod perm="a+x">
			<fileset dir="${app.server.glassfish.bin.dir}">
				<exclude name="*.bat" />
			</fileset>
		</chmod>
	</target>

	<target name="unzip-jboss">
		<delete dir="${app.server.jboss.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.jboss.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<trycatch>
					<try>
						<mirrors-get
							dest="${app.server.parent.dir}/${app.server.jboss.zip.name}"
							src="${app.server.jboss.zip.url}"
							verbose="true"
						/>
					</try>
					<catch>
						<fail>
.

Please download the JBoss zip file from ${app.server.jboss.zip.url} and
place it here: ${app.server.parent.dir}/${app.server.jboss.zip.name}. Then rerun
this task.
						</fail>
					</catch>
				</trycatch>
			</then>
		</if>

		<unzip
			dest="${app.server.parent.dir}"
			src="${app.server.parent.dir}/${app.server.jboss.zip.name}"
		>
			<mapper
				from="(jboss-eap-)\d\.\d[\.]?[\d]?(/.*)"
				to="\1${app.server.jboss.version}\2"
				type="regexp"
			 />
		</unzip>

		<property name="app.server.jboss.module.file" value="${app.server.jboss.dir}/modules/system/layers/base/sun/jdk/main/module.xml" />

		<replace file="${app.server.jboss.module.file}">
			<replacetoken><![CDATA[<paths>]]></replacetoken>
			<replacevalue>
				<![CDATA[
					<paths>
						<path name="com/sun/crypto" />
						<path name="com/sun/crypto/provider" />
						<path name="com/sun/image/codec/jpeg" />
						<path name="com/sun/org/apache/xml/internal/resolver" />
						<path name="com/sun/org/apache/xml/internal/resolver/tools" />
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.jboss.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[enable-welcome-root="true"]]></replacetoken>
			<replacevalue><![CDATA[enable-welcome-root="false"]]></replacevalue>
		</replace>

		<replace file="${app.server.jboss.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[</extensions>]]></replacetoken>
			<replacevalue>
				<![CDATA[
					</extensions>
						<system-properties>
							<property name="org.apache.catalina.connector.URI_ENCODING" value="UTF-8" />
							<property name="org.apache.catalina.connector.USE_BODY_ENCODING_FOR_QUERY_STRING" value="true" />
						</system-properties>
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.jboss.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<deployment-scanner ]]></replacetoken>
			<replacevalue><![CDATA[<deployment-scanner deployment-timeout="360" ]]></replacevalue>
		</replace>

		<replace file="${app.server.jboss.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<security-domains>]]></replacetoken>
			<replacevalue>
				<![CDATA[
					<security-domains>
						<security-domain name="PortalRealm">
							<authentication>
								<login-module code="com.liferay.portal.security.jaas.PortalLoginModule" flag="required" />
							</authentication>
						</security-domain>
				]]>
			</replacevalue>
		</replace>

		<echo file="${app.server.jboss.bin.dir}/server.policy">
			grant {
				permission java.security.AllPermission;
			};
		</echo>

		<if>
			<equals arg1="${java.security.manager.option}" arg2="" />
			<then>
				<var name="java.security.config" value="" />
			</then>
			<else>
				<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==${app.server.jboss.dir}/bin/server.policy -Djboss.home.dir=${app.server.jboss.dir}" />
			</else>
		</if>

		<replace file="${app.server.jboss.bin.dir}/standalone.conf">
			<replacetoken><![CDATA[JAVA_OPTS="-Xms1303m -Xmx1303m -XX:MaxPermSize=256m ]]></replacetoken>
			<replacevalue><![CDATA[JAVA_OPTS="]]></replacevalue>
		</replace>

		<echo append="true" file="${app.server.jboss.bin.dir}/standalone.conf">
			<![CDATA[
				JAVA_OPTS="$JAVA_OPTS -Dfile.encoding=UTF-8 -Djava.net.preferIPv4Stack=true ${java.security.config} -Djboss.as.management.blocking.timeout=480 -Duser.timezone=GMT -Xmx1024m -XX:MaxMetaspaceSize=384m"
			]]>
		</echo>

		<replace file="${app.server.jboss.bin.dir}/standalone.conf.bat">
			<replacetoken><![CDATA[set "JAVA_OPTS=-Xms1G -Xmx1G -XX:MaxPermSize=256M"]]></replacetoken>
			<replacevalue></replacevalue>
		</replace>

		<replace file="${app.server.jboss.bin.dir}/standalone.conf.bat">
			<replacefilter token="@java.security.config@" value="${java.security.config}" />
			<replacetoken><![CDATA[:JAVA_OPTS_SET]]></replacetoken>
			<replacevalue>
				<![CDATA[
					set "JAVA_OPTS=%JAVA_OPTS% -Dfile.encoding=UTF-8 -Djava.net.preferIPv4Stack=true @java.security.config@ -Djboss.as.management.blocking.timeout=480 -Duser.timezone=GMT -Xmx1024m -XX:MaxMetaspaceSize=384m"

					:JAVA_OPTS_SET
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.jboss.instance.dir}/configuration/standalone.xml">
			<replacetoken><![CDATA[<subsystem xmlns="urn:jboss:domain:web:2.2" default-virtual-server="default-host" native="false">]]></replacetoken>
			<replacevalue>
				<![CDATA[
					<subsystem xmlns="urn:jboss:domain:web:2.2" default-virtual-server="default-host" native="false">
						<configuration>
							<jsp-configuration development="true" />
						</configuration>
				]]>
			</replacevalue>
		</replace>

		<chmod perm="a+x">
			<fileset dir="${app.server.jboss.bin.dir}">
				<include name="*.sh" />
			</fileset>
		</chmod>
	</target>

	<target name="unzip-jetty">
		<delete dir="${app.server.jetty.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.jetty.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.jetty.zip.name}"
					src="${app.server.jetty.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<unzip
			dest="${app.server.parent.dir}"
			src="${app.server.parent.dir}/${app.server.jetty.zip.name}"
		>
			<patternset
				excludes="
					jetty-distribution-${app.server.jetty.version}.v${app.server.jetty.version.date}/bin/**,
					jetty-distribution-${app.server.jetty.version}.v${app.server.jetty.version.date}/contexts/**,
					jetty-distribution-${app.server.jetty.version}.v${app.server.jetty.version.date}/contexts-available/**,
					jetty-distribution-${app.server.jetty.version}.v${app.server.jetty.version.date}/javadoc/**,
					jetty-distribution-${app.server.jetty.version}.v${app.server.jetty.version.date}/overlays/**,
					jetty-distribution-${app.server.jetty.version}.v${app.server.jetty.version.date}/webapps/**"
			/>
			<mapper
				type="glob"
				from="jetty-distribution-${app.server.jetty.version}.v${app.server.jetty.version.date}/*"
				to="jetty-${app.server.jetty.version}/*"
			/>
		</unzip>

		<mkdir dir="${app.server.jetty.dir}/bin" />
		<mkdir dir="${app.server.jetty.dir}/contexts" />
		<mkdir dir="${app.server.jetty.dir}/temp" />
		<mkdir dir="${app.server.jetty.dir}/webapps" />

		<echo file="${app.server.jetty.dir}/lib/policy/server.policy">
			grant {
				permission java.security.AllPermission;
			};
		</echo>

		<if>
			<equals arg1="${java.security.manager.option}" arg2="" />
			<then>
				<var name="java.security.config" value="" />
			</then>
			<else>
				<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==${app.server.jetty.dir}/lib/policy/server.policy -Djetty.home=${app.server.jetty.dir}" />
			</else>
		</if>

		<copy
			file="tools/servers/jetty/bin/run.bat"
			tofile="${app.server.jetty.bin.dir}/run.bat"
		>
			<filterset>
				<filter token="java.security.config" value="${java.security.config}" />
			</filterset>
		</copy>

		<replace file="${app.server.jetty.bin.dir}/run.bat">
			<replacetoken>set "JAVA_OPTS=-D</replacetoken>
			<replacevalue>set "JAVA_OPTS=-Dapp.server.jetty.version=${app.server.jetty.version} -Dapp.server.jetty.version.date=${app.server.jetty.version.date} -Djava.io.tmpdir=${app.server.jetty.dir}/temp -D</replacevalue>
		</replace>

		<loadfile property="run.bat.content" srcfile="${app.server.jetty.bin.dir}/run.bat">
			<filterchain>
				<expandproperties />
			</filterchain>
		</loadfile>

		<echo file="${app.server.jetty.bin.dir}/run.bat">${run.bat.content}</echo>

		<copy
			file="tools/servers/jetty/bin/run.sh"
			tofile="${app.server.jetty.bin.dir}/run.sh"
		>
			<filterset>
				<filter token="java.security.config" value="${java.security.config}" />
			</filterset>
		</copy>

		<replace file="${app.server.jetty.bin.dir}/run.sh">
			<replacetoken>export JAVA_OPTS="-D</replacetoken>
			<replacevalue>export JAVA_OPTS="-Dapp.server.jetty.version=${app.server.jetty.version} -Dapp.server.jetty.version.date=${app.server.jetty.version.date} -D</replacevalue>
		</replace>

		<loadfile property="run.sh.content" srcfile="${app.server.jetty.bin.dir}/run.sh">
			<filterchain>
				<expandproperties />
			</filterchain>
		</loadfile>

		<echo file="${app.server.jetty.bin.dir}/run.sh">${run.sh.content}</echo>

		<copy
			file="tools/servers/jetty/bin/start.ini"
			tofile="${app.server.jetty.bin.dir}/start.ini"
		/>

		<chmod perm="a+x">
			<fileset dir="${app.server.jetty.bin.dir}">
				<include name="*.sh" />
			</fileset>
		</chmod>
	</target>

	<target name="unzip-jonas">
		<delete dir="${app.server.jonas.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.jonas.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.jonas.zip.name}"
					src="${app.server.jonas.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<unzip
			dest="${app.server.parent.dir}"
			src="${app.server.parent.dir}/${app.server.jonas.zip.name}"
		>
			<patternset
				excludes="jonas-full-${app.server.jonas.version}/examples/**,jonas-full-${app.server.jonas.version}/tutorial/**"
			/>
			<mapper
				type="glob"
				from="jonas-full-${app.server.jonas.version}/*"
				to="jonas-${app.server.jonas.version}/*"
			/>
		</unzip>

		<delete failonerror="false" includeemptydirs="true">
			<fileset
				dir="${app.server.jonas.dir}/conf"
				includes="db2.properties,FirebirdSQL.properties,HSQL1.properties,jetty*.xml,InstantDB1.properties,InterBase1.properties,MailMimePartDS1.properties,MailSession1.properties,McKoi1.properties,MySQL.properties,Oracle1.properties,PostgreSQL1.properties,spy.properties,Sybase1.properties"
			/>
			<fileset
				dir="${app.server.jonas.dir}/deploy"
				includes="ctxroot.xml,doc.xml,jdbc-ds.xml,jonasAdmin.xml"
			/>
			<fileset
				dir="${app.server.jonas.dir}/repositories/maven2-internal"
				includes="org/mortbay/**,org/ow2/jonas/documentation/**,org/ow2/jonas/jonas-admin/**,org/ow2/jonas/jonas-ctxroot/**"
			/>
		</delete>

		<replace file="${app.server.jonas.dir}/conf/classloader-default-filtering.xml">
			<replacetoken><![CDATA[<filter-name>org.apache.commons.digester.*</filter-name>]]></replacetoken>
			<replacevalue>
				<![CDATA[
					<filter-name>antlr.*</filter-name>
					<filter-name>EDU.oswego.*</filter-name>
					<filter-name>javassist.*</filter-name>
					<filter-name>net.sf.cglib.*</filter-name>
					<filter-name>net.sf.ehcache.*</filter-name>
					<filter-name>org.apache.commons.*</filter-name>
					<filter-name>org.dom4j.*</filter-name>
					<filter-name>org.hibernate.*</filter-name>
					<filter-name>org.jboss.*</filter-name>
					<filter-name>org.objectweb.asm.*</filter-name>
					<filter-name>org.objectweb.jotm.*</filter-name>
					<filter-name>org.quartz.*</filter-name>
					<filter-name>org.springframework.*</filter-name>
				]]>
			</replacevalue>
		</replace>

		<unjar dest="${app.server.jonas.dir}/conf" src="${app.server.jonas.dir}/lib/bootstrap/felix-launcher.jar">
			<patternset>
				<include name="**/default.properties" />
			</patternset>
			<chainedmapper>
				<flattenmapper />
				<globmapper
					from="default.properties"
					to="felix-config.properties"
				/>
			</chainedmapper>
		</unjar>

		<replace file="${app.server.jonas.dir}/conf/felix-config.properties">
			<replacetoken>org.osgi.framework.system.packages=org.osgi.framework;</replacetoken>
			<replacevalue>org.osgi.framework.system.packages=com.sun.crypto.provider; com.sun.image.codec.jpeg; com.sun.jmx.interceptor; com.sun.jmx.mbeanserver; org.apache.xerces.parsers; org.apache.xerces.util; org.apache.xerces.xni; org.apache.xerces.xni.parser; org.osgi.framework;</replacevalue>
		</replace>

		<replace file="${app.server.jonas.dir}/conf/jonas.properties">
			<replacefilter token="HSQL1" value="" />
			<replacefilter token="jtm,db,resource,ejb3,jaxws,web,ear,depmonitor" value="jtm,resource,ejb3,jaxws,web,ear,validation,depmonitor" />
		</replace>

		<replace file="${app.server.jonas.dir}/conf/tomcat6-server.xml">
			<replacetoken><![CDATA[autoDeploy="false"]]></replacetoken>
			<replacevalue><![CDATA[autoDeploy="true"]]></replacevalue>
		</replace>

		<replace file="${app.server.jonas.dir}/conf/tomcat6-server.xml">
			<replacefilter token="9000" value="8080" />
			<replacefilter token="9009" value="8009" />
			<replacefilter token="9043" value="8443" />
		</replace>

		<replace file="${app.server.jonas.dir}/conf/tomcat6-server.xml">
			<replacetoken><![CDATA[redirectPort="8443" />]]></replacetoken>
			<replacevalue><![CDATA[redirectPort="8443" URIEncoding="UTF-8" />]]></replacevalue>
		</replace>

		<replace file="${app.server.jonas.dir}/conf/tomcat6-server.xml">
			<replacetoken><![CDATA[redirectPort="9043" />]]></replacetoken>
			<replacevalue><![CDATA[redirectPort="9043" URIEncoding="UTF-8" />]]></replacevalue>
		</replace>

		<replace file="${app.server.jonas.dir}/conf/osgi/defaults.properties">
			<replacetoken><![CDATA[javase-packages ${javase-${javase.version}}]]></replacetoken>
			<replacevalue><![CDATA[javase-packages ${javase-${javase.version}}, com.sun.crypto.provider, com.sun.jmx.interceptor, com.sun.jmx.mbeanserver, org.apache.felix.framework]]></replacevalue>
		</replace>

		<if>
			<equals arg1="${java.security.manager.option}" arg2="" />
			<then>
				<var name="java.security.config" value="" />
			</then>
			<else>
				<if>
					<os family="windows" />
					<then>
						<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==%JONAS_ROOT%/conf/java.policy" />
					</then>
					<else>
						<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==$JONAS_ROOT/conf/java.policy" />
					</else>
				</if>
			</else>
		</if>

		<replace file="${app.server.jonas.bin.dir}/setenv">
			<replacefilter token="@java.security.config@" value="${java.security.config}" />
			<replacetoken><![CDATA[export JAVA_OPTS]]></replacetoken>
			<replacevalue>
				<![CDATA[
					JAVA_OPTS="-Dfile.encoding=UTF8 -Djava.net.preferIPv4Stack=true @java.security.config@ -Djonas.felix.configuration.file=\"$JONAS_ROOT/conf/felix-config.properties\" -Duser.timezone=GMT -Xmx1024m -XX:MaxPermSize=384m"

					export JAVA_OPTS
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.jonas.bin.dir}/setenv.bat">
			<replacefilter token="@java.security.config@" value="${java.security.config}" />
			<replacetoken><![CDATA[set JONAS_CLASSPATH=%JONAS_BASE%\conf;%JONAS_CLASSPATH%]]></replacetoken>
			<replacevalue>
				<![CDATA[
					set JONAS_CLASSPATH=%JONAS_BASE%\conf;%JONAS_CLASSPATH%

					set "JAVA_OPTS=-Dfile.encoding=UTF8 -Djava.net.preferIPv4Stack=true @java.security.config@ -Djonas.felix.configuration.file=%JONAS_ROOT%/conf/felix-config.properties -Duser.timezone=GMT -Xmx1024m -XX:MaxPermSize=384m"
				]]>
			</replacevalue>
		</replace>

		<chmod perm="a+x">
			<fileset dir="${app.server.jonas.bin.dir}">
				<exclude name="*.bat" />
			</fileset>
		</chmod>
	</target>

	<target name="unzip-resin">
		<delete dir="${app.server.resin.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.resin.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.resin.zip.name}"
					src="${app.server.resin.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<unzip
			dest="${app.server.parent.dir}"
			src="${app.server.parent.dir}/${app.server.resin.zip.name}"
		>
			<patternset
				excludes="resin-${app.server.resin.version}/php/**,resin-${app.server.resin.version}/webapps/**"
			/>
		</unzip>

		<mkdir dir="${app.server.resin.dir}/webapps" />

		<echo file="${app.server.resin.dir}/conf/server.policy">
			grant {
				permission java.security.AllPermission;
			};
		</echo>

		<if>
			<equals arg1="${java.security.manager.option}" arg2="" />
			<then>
				<var name="java.security.config" value="" />
			</then>
			<else>
				<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==${app.server.resin.dir}/conf/server.policy" />
			</else>
		</if>

		<replace file="${app.server.resin.dir}/conf/resin.properties">
			<replacefilter token="@java.security.config@" value="${java.security.config}" />
			<replacetoken><![CDATA[# jvm_args  : -Xmx2048m -XX:MaxPermSize=256m]]></replacetoken>
			<replacevalue><![CDATA[jvm_args  : -Dfile.encoding=UTF-8 -Dcaucho.environment.class.loader=com.liferay.support.resin.EnvironmentClassLoader -Djava.net.preferIPv4Stack=true @java.security.config@ -Duser.timezone=GMT -Xmx1024m -XX:MaxPermSize=384m]]></replacevalue>
		</replace>

		<replace file="${app.server.resin.dir}/conf/resin.xml">
			<replacetoken><![CDATA[xmlns:resin="urn:java:com.caucho.resin">]]></replacetoken>
			<replacevalue>
				<![CDATA[
					xmlns:resin="urn:java:com.caucho.resin">

					<class-loader>
						<tree-loader path="${resin.root}/ext-lib" />
						<tree-loader path="${resin.root}/resin-inf" />
						<tree-loader path="cloud:/resin-inf" />
					</class-loader>
				 ]]>
				</replacevalue>
		</replace>

		<copy
			file="tools/servers/resin/bin/run.bat"
			tofile="${app.server.resin.bin.dir}/run.bat"
		/>

		<copy
			file="tools/servers/resin/bin/run.sh"
			tofile="${app.server.resin.bin.dir}/run.sh"
		/>

		<chmod perm="a+x">
			<fileset dir="${app.server.resin.bin.dir}">
				<include name="*.sh" />
			</fileset>
		</chmod>
	</target>

	<target name="unzip-tcserver">
		<delete dir="${app.server.tcserver.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.tcserver.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.tcserver.zip.name}"
					src="${app.server.tcserver.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<unzip
			dest="${app.server.parent.dir}"
			src="${app.server.parent.dir}/${app.server.tcserver.zip.name}"
		>
			<mapper
				from="pivotal-tc-server-developer-${app.server.tcserver.version}.RELEASE/*"
				to="tc-server-${app.server.tcserver.version}/*"
				type="glob"
			/>
		</unzip>

		<chmod perm="a+x">
			<fileset dir="${app.server.tcserver.dir}">
				<include name="**/*.sh" />
			</fileset>
		</chmod>

		<if>
			<os family="windows" />
			<then>
				<exec dir="${app.server.tcserver.dir}" executable="cmd">
					<arg line="/c set JAVA_OPTS= &amp; tcruntime-instance.bat create liferay -v ${app.server.tcserver.tomcat.version}" />
				</exec>
			</then>
			<else>
				<exec dir="${app.server.tcserver.dir}" executable="${app.server.tcserver.dir}/tcruntime-instance.sh">
					<arg line="create liferay -v ${app.server.tcserver.tomcat.version}" />
				</exec>
			</else>
		</if>

		<if>
			<os family="windows" />
			<then>
				<replace file="${app.server.tcserver.bin.dir}/setenv.bat">
					<replacetoken><![CDATA[set JVM_OPTS=-Xmx512M -Xss256K]]></replacetoken>
					<replacevalue><![CDATA[set JVM_OPTS=-Xmx1024M -Xss512K -XX:MaxMetaspaceSize=512m]]></replacevalue>
				</replace>
			</then>
			<else>
				<replace file="${app.server.tcserver.bin.dir}/setenv.sh">
					<replacetoken><![CDATA[JVM_OPTS="-Xmx512M -Xss256K"]]></replacetoken>
					<replacevalue><![CDATA[JVM_OPTS="-Xmx1024M -Xss512K -XX:MaxPermSize=512m"]]></replacevalue>
				</replace>
			</else>
		</if>

		<replace file="${app.server.tcserver.dir}/liferay/conf/catalina.properties">
			<replacetoken><![CDATA[common.loader=${catalina.base}/lib,${catalina.base}/lib/*.jar,${catalina.home}/lib,${catalina.home}/lib/*.jar]]></replacetoken>
			<replacevalue><![CDATA[common.loader=${catalina.base}/lib,${catalina.base}/lib/*.jar,${catalina.home}/lib,${catalina.home}/lib/*.jar,${catalina.home}/lib/ext,${catalina.home}/lib/ext/*.jar]]></replacevalue>
		</replace>

		<replace file="${app.server.tcserver.dir}/liferay/conf/server.xml">
			<replacetoken><![CDATA[redirectPort="${bio.https.port}"/>]]></replacetoken>
			<replacevalue><![CDATA[redirectPort="${bio.https.port}" URIEncoding="UTF-8"/>]]></replacevalue>
		</replace>

		<if>
			<os family="windows" />
			<then>
				<replace file="${app.server.tcserver.dir}/liferay/conf/wrapper.conf">
					<replacetoken><![CDATA[wrapper.java.additional.8=-Xmx512M]]></replacetoken>
					<replacevalue><![CDATA[wrapper.java.additional.8="-Xmx1024M"]]></replacevalue>
				</replace>

				<replace file="${app.server.tcserver.dir}/liferay/conf/wrapper.conf">
					<replacetoken><![CDATA[wrapper.java.additional.9=-Xss256K]]></replacetoken>
					<replacevalue><![CDATA[wrapper.java.additional.9="-Xss512K"
wrapper.java.additional.10="-XX:MaxPermSize=256M"
wrapper.java.additional.11="-Dfile.encoding=UTF-8"]]></replacevalue>
				</replace>
			</then>
		</if>
	</target>

	<target name="unzip-tomcat">
		<delete dir="${app.server.tomcat.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.tomcat.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.tomcat.zip.name}"
					src="${app.server.tomcat.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<basename file="${app.server.tomcat.dir}" property="app.server.tomcat.dir.name" />

		<unzip
			dest="${app.server.parent.dir}"
			src="${app.server.parent.dir}/${app.server.tomcat.zip.name}"
		>
			<patternset
				excludes="apache-tomcat-${app.server.tomcat.version}/webapps/**"
			/>
			<mapper
				type="glob"
				from="apache-tomcat-${app.server.tomcat.version}/*"
				to="${app.server.tomcat.dir.name}/*"
			/>
		</unzip>

		<mkdir dir="${app.server.tomcat.dir}/webapps" />

		<echo file="${app.server.tomcat.dir}/conf/catalina.policy">
			grant {
				permission java.security.AllPermission;
			};
		</echo>

		<replace file="${app.server.tomcat.dir}/conf/catalina.properties">
			<replacetoken><![CDATA[common.loader="${catalina.base}/lib","${catalina.base}/lib/*.jar","${catalina.home}/lib","${catalina.home}/lib/*.jar"]]></replacetoken>
			<replacevalue><![CDATA[common.loader="${catalina.base}/lib","${catalina.base}/lib/*.jar","${catalina.home}/lib","${catalina.home}/lib/*.jar","${catalina.home}/lib/ext","${catalina.home}/lib/ext/*.jar"]]></replacevalue>
		</replace>

		<replace file="${app.server.tomcat.dir}/conf/server.xml">
			<replacetoken><![CDATA[redirectPort="8443" />]]></replacetoken>
			<replacevalue><![CDATA[redirectPort="8443" URIEncoding="UTF-8" />]]></replacevalue>
		</replace>

		<!--<replace file="${app.server.tomcat.dir}/conf/server.xml">
			<replacetoken><![CDATA[xmlValidation="false" xmlNamespaceAware="false">]]></replacetoken>
			<replacevalue><![CDATA[xmlValidation="false" deployXML="false" xmlNamespaceAware="false">]]></replacevalue>
		</replace>-->

		<if>
			<available file="${jdk.windows.home}/jre/bin/java.exe" />
			<then>
				<copy todir="${app.server.tomcat.dir}/jre${jdk.windows.version}/win">
					<fileset dir="${jdk.windows.home}/jre" />
				</copy>
			</then>
		</if>

		<chmod perm="a+x">
			<fileset dir="${app.server.tomcat.bin.dir}">
				<include name="*.sh" />
			</fileset>
		</chmod>

		<antcall target="update-java-security-tomcat" />
	</target>

	<target name="unzip-weblogic">
		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.weblogic.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}"
					src="${app.server.weblogic.zip.url}"
				/>
			</then>
		</if>

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.weblogic.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<fail>
.

Please download the WebLogic zip file from ${app.server.weblogic.zip.url} and
place it here: ${app.server.parent.dir}/${app.server.weblogic.zip.name}. Then
rerun this task.
				</fail>
			</then>
		</if>

		<delete dir="${app.server.weblogic.dir}" />

		<if>
			<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
			<then>
				<unzip
					dest="${app.server.weblogic.dir}-temp"
					src="${app.server.parent.dir}/${app.server.weblogic.zip.name}"
				/>
			</then>
			<else>
				<unzip
					dest="${app.server.weblogic.dir}"
					src="${app.server.parent.dir}/${app.server.weblogic.zip.name}"
				/>
			</else>
		</if>

		<if>
			<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
			<then>
				<java fork="true" jar="${app.server.weblogic.dir}-temp/${app.server.weblogic.jar.name}">
					<arg line="ORACLE_HOME=${app.server.weblogic.dir}" />
				</java>

				<delete dir="${app.server.weblogic.dir}-temp" />

				<property name="app.server.weblogic.configure.silent" value="-silent" />
				<property name="app.server.weblogic.template.dir" value="${app.server.weblogic.wlserver.dir}/common/templates/wls" />
			</then>
			<elseif>
				<equals arg1="${app.server.weblogic.version.build}" arg2="1213" />
				<then>
					<move todir="${app.server.weblogic.dir}">
						<fileset dir="${app.server.weblogic.dir}/wls${app.server.weblogic.version.build}0" />
					</move>

					<property name="app.server.weblogic.configure.silent" value="-silent" />
					<property name="app.server.weblogic.template.dir" value="${app.server.weblogic.wlserver.dir}/common/templates/wls" />
				</then>
			</elseif>
			<else>
				<property name="app.server.weblogic.configure.silent" value="" />
				<property name="app.server.weblogic.template.dir" value="${app.server.weblogic.wlserver.dir}/common/templates/domains" />
			</else>
		</if>

		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<mkdir dir="${tstamp.value}" />

		<echo file="${tstamp.value}/create-weblogic-domain.py">
readTemplate('${app.server.weblogic.template.dir}/wls.jar')

set('Name', '${app.server.weblogic.instance.name}')

cd('/Security/%s/User/%s' % ('${app.server.weblogic.instance.name}', 'weblogic'))

set('UserPassword', 'testing123')

cd('/Servers/AdminServer')

set('ListenAddress', '')
set('ListenPort', 8080)

writeDomain('${app.server.weblogic.instance.dir}')

closeTemplate()
		</echo>

		<if>
			<os family="windows" />
			<then>
				<pathconvert property="app.server.weblogic.dir.windows" targetos="windows">
					<path location="${app.server.weblogic.dir}" />
				</pathconvert>

				<pathconvert property="app.server.weblogic.wlserver.dir.windows" targetos="windows">
					<path location="${app.server.weblogic.wlserver.dir}" />
				</pathconvert>

				<if>
					<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
					<then>
						<exec dir="${app.server.weblogic.dir}/wlserver/server/bin" executable="cmd">
							<env key="MW_HOME" value="${app.server.weblogic.dir.windows}" />
							<arg value="/c" />
							<arg value="setWLSEnv.cmd" />
							<arg value="${app.server.weblogic.configure.silent}" />
						</exec>

						<echo file="${tstamp.value}/create-weblogic-domain.bat">
							@echo off

							set "MW_HOME=${app.server.weblogic.dir.windows}"
							set "USER_MEM_ARGS=-Xmx1024m -XX:MetaspaceSize=256m"
							set "WL_HOME=${app.server.weblogic.wlserver.dir.windows}"

							call %MW_HOME%/oracle_common/common/bin/commEnv.cmd

							set "CLASSPATH=%FMWCONFIG_CLASSPATH%"

							"${env.JAVA_HOME}/bin/java" weblogic.WLST create-weblogic-domain.py
						</echo>
					</then>
					<else>
						<exec dir="${app.server.weblogic.dir}" executable="cmd">
							<env key="MW_HOME" value="${app.server.weblogic.dir.windows}" />
							<arg value="/c" />
							<arg value="configure.cmd" />
							<arg value="${app.server.weblogic.configure.silent}" />
						</exec>

						<echo file="${tstamp.value}/create-weblogic-domain.bat">
							@echo off

							set "MW_HOME=${app.server.weblogic.dir.windows}"
							set "USER_MEM_ARGS=-Xmx1024m -XX:MetaspaceSize=256m"
							set "WL_HOME=${app.server.weblogic.wlserver.dir.windows}"

							call %WL_HOME%/common/bin/commEnv.cmd

							set "CLASSPATH=%FMWCONFIG_CLASSPATH%"

							"${env.JAVA_HOME}/bin/java" weblogic.WLST create-weblogic-domain.py
						</echo>
					</else>
				</if>

				<exec dir="${tstamp.value}" executable="cmd">
					<arg value="/c" />
					<arg value="create-weblogic-domain.bat" />
				</exec>

				<replace file="${app.server.weblogic.instance.dir}/startWebLogic.cmd">
					<replacefilter token="@java.security.manager.option@" value="${java.security.manager.option}" />
					<replacetoken><![CDATA[SETLOCAL]]></replacetoken>
					<replacevalue>
						<![CDATA[
							SETLOCAL

							set DERBY_FLAG="false"
							set "JAVA_OPTIONS=%JAVA_OPTIONS% -Dfile.encoding=UTF-8 @java.security.manager.option@ -da:org.apache.lucene... -da:org.aspectj..."
							set "MW_HOME=${app.server.weblogic.dir.windows}"
							set "USER_MEM_ARGS=-Xmx1024m -XX:PermSize=512m"
						]]>
					</replacevalue>
				</replace>

				<replace file="${app.server.weblogic.instance.dir}/startWebLogic.cmd">
					<replacefilter token="$${app.server.weblogic.dir.windows}" value="${app.server.weblogic.dir.windows}" />
				</replace>

				<copy
					file="${app.server.weblogic.instance.dir}/startWebLogic.cmd"
					tofile="${app.server.weblogic.instance.dir}/stopWebLogic.cmd"
				/>

				<replace file="${app.server.weblogic.instance.dir}/stopWebLogic.cmd">
					<replacefilter token="startWebLogic" value="stopWebLogic" />
				</replace>
			</then>
			<else>
				<var name="source.command" value="source" />

				<if>
					<os family="unix" />
					<then>
						<if>
							<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
							<then>
								<replace file="${app.server.weblogic.dir}/wlserver/server/bin/setWLSEnv.sh">
									<replacefilter token="#!/bin/sh" value="#!/bin/bash" />
								</replace>

								<var name="source.command" value="." />
							</then>
							<else>
								<replace file="${app.server.weblogic.dir}/configure.sh">
									<replacefilter token="#!/bin/sh" value="#!/bin/bash" />
								</replace>

								<var name="source.command" value="." />
							</else>
						</if>
					</then>
				</if>

				<if>
					<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
					<then>
						<chmod
							dir="${app.server.weblogic.dir}/wlserver/server/bin"
							includes="setWLSEnv.sh"
							perm="744"
						/>
					</then>
					<else>
						<chmod
							dir="${app.server.weblogic.dir}"
							includes="configure.sh"
							perm="744"
						/>
					</else>
				</if>

				<if>
					<os family="unix" />
					<then>
						<if>
							<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
							<then>
								<exec dir="${app.server.weblogic.dir}/wlserver/server/bin" executable="./setWLSEnv.sh">
									<env file="${app.server.weblogic.dir}" key="MW_HOME" />
									<arg value="${app.server.weblogic.configure.silent}" />
								</exec>
							</then>
							<else>
								<exec dir="${app.server.weblogic.dir}" executable="./configure.sh">
									<env file="${app.server.weblogic.dir}" key="MW_HOME" />
									<arg value="${app.server.weblogic.configure.silent}" />
								</exec>
							</else>
						</if>
					</then>
					<else>
						<if>
							<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
							<then>
								<exec dir="${app.server.weblogic.dir}/wlserver/server/bin" executable="sh">
									<env file="${app.server.weblogic.dir}" key="MW_HOME" />
									<arg value="setWLSEnv.sh" />
								</exec>
							</then>
							<else>
								<exec dir="${app.server.weblogic.dir}" executable="sh">
									<env file="${app.server.weblogic.dir}" key="MW_HOME" />
									<arg value="configure.sh" />
								</exec>
							</else>
						</if>
					</else>
				</if>

				<if>
					<equals arg1="${app.server.weblogic.version.build}" arg2="1221" />
					<then>
						<echo file="${tstamp.value}/create-weblogic-domain.sh">
							#!/bin/sh

							export MW_HOME="${app.server.weblogic.dir}"
							export USER_MEM_ARGS="-Xmx1024m -XX:MetaspaceSize=256m"
							export WL_HOME="${app.server.weblogic.wlserver.dir}"

							${source.command} ${MW_HOME}/oracle_common/common/bin/commEnv.sh

							export CLASSPATH=${FMWCONFIG_CLASSPATH}

							${env.JAVA_HOME}/bin/java weblogic.WLST create-weblogic-domain.py
						</echo>
					</then>
					<else>
						<echo file="${tstamp.value}/create-weblogic-domain.sh">
							#!/bin/sh

							export MW_HOME="${app.server.weblogic.dir}"
							export USER_MEM_ARGS="-Xmx1024m -XX:MetaspaceSize=256m"
							export WL_HOME="${app.server.weblogic.wlserver.dir}"

							${source.command} ${WL_HOME}/common/bin/commEnv.sh

							export CLASSPATH=${FMWCONFIG_CLASSPATH}

							${env.JAVA_HOME}/bin/java weblogic.WLST create-weblogic-domain.py
						</echo>
					</else>
				</if>

				<chmod
					file="${tstamp.value}/create-weblogic-domain.sh"
					perm="744"
				/>

				<exec dir="${tstamp.value}" executable="sh">
					<arg value="create-weblogic-domain.sh" />
				</exec>

				<replace file="${app.server.weblogic.instance.dir}/startWebLogic.sh">
					<replacefilter token="@java.security.manager.option@" value="${java.security.manager.option}" />
					<replacetoken><![CDATA[# Any changes to this script may be lost when adding extensions to this configuration.]]></replacetoken>
					<replacevalue>
						<![CDATA[
							# Any changes to this script may be lost when adding extensions to this configuration.

							export DERBY_FLAG="false"
							export JAVA_OPTIONS="${JAVA_OPTIONS} @java.security.manager.option@ -da:org.apache.lucene... -da:org.aspectj..."
							export MW_HOME="${app.server.weblogic.dir}"
							export USER_MEM_ARGS="-Xmx1024m -XX:MetaspaceSize=512m"
						]]>
					</replacevalue>
				</replace>

				<replace file="${app.server.weblogic.instance.dir}/startWebLogic.sh">
					<replacefilter token="$${app.server.weblogic.dir}" value="${app.server.weblogic.dir}" />
				</replace>

				<copy
					file="${app.server.weblogic.instance.dir}/startWebLogic.sh"
					tofile="${app.server.weblogic.instance.dir}/stopWebLogic.sh"
				/>

				<replace file="${app.server.weblogic.instance.dir}/stopWebLogic.sh">
					<replacefilter token="startWebLogic" value="stopWebLogic" />
				</replace>

				<replace file="${app.server.weblogic.instance.dir}/bin/setDomainEnv.sh">
					<replacetoken><![CDATA[JAVA_PROPERTIES="${JAVA_PROPERTIES} ${CLUSTER_PROPERTIES}"]]></replacetoken>
					<replacevalue><![CDATA[JAVA_PROPERTIES="-Dfile.encoding=utf8 ${JAVA_PROPERTIES} ${CLUSTER_PROPERTIES}"]]></replacevalue>
				</replace>

				<chmod
					dir="${app.server.weblogic.instance.dir}"
					includes="**/*.sh"
					perm="744"
				/>
			</else>
		</if>

		<echo file="${app.server.weblogic.dir}/wlserver/server/lib/weblogic.policy">
			grant {
				permission java.security.AllPermission;
			};
		</echo>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="unzip-weblogic-custom">
		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.weblogic.custom.zip.name}" />
			</not>
			<then>
				<trycatch>
					<try>
						<mkdir dir="${app.server.parent.dir}" />

						<mirrors-get
							dest="${app.server.parent.dir}/${app.server.weblogic.custom.zip.name}"
							src="http://files.liferay.com/private/apps/oracle/weblogicas/12/${app.server.weblogic.custom.zip.name}"
							verbose="true"
						/>
					</try>
					<catch>
						<fail>
.

Please download the Weblogic custom zip file from
http://mirrors/files.liferay.com/private/apps/oracle/weblogicas/12 and
place it here: ${app.server.parent.dir}/${app.server.weblogic.custom.zip.name}. Then rerun
this task.
						</fail>
					</catch>
				</trycatch>
			</then>
		</if>

		<delete dir="${app.server.weblogic.dir}" />

		<unzip
			dest="${app.server.weblogic.dir}"
			src="${app.server.parent.dir}/${app.server.weblogic.custom.zip.name}"
		/>

		<if>
			<os family="unix" />
			<then>
				<replace
					dir="${app.server.weblogic.dir}"
					includes="**/*.cmd,**/*.domains,**/*.properties,**/*.sh,**/*.xml"
				>
					<replacefilter token="@env.JAVA_HOME@" value="${env.JAVA_HOME}" />
				</replace>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<propertyregex
						input="${app.server.weblogic.dir.windows}"
						property="app.server.weblogic.dir.windows.double.slash"
						regexp="\\"
						replace="\\\\\\\\"
					/>

					<propertyregex
						input="${app.server.weblogic.dir.windows.double.slash}"
						property="app.server.weblogic.dir.windows.escaped"
						regexp=":"
						replace="\\\\:"
					/>

					<replace
						dir="${app.server.weblogic.dir}"
						includes="**/*.cmd,**/*.domains,**/*.properties,**/*.sh,**/*.xml"
					>
						<replacefilter token="@app.server.weblogic.dir@" value="${app.server.weblogic.dir}" />
						<replacefilter token="@app.server.weblogic.dir.windows@" value="${app.server.weblogic.dir.windows}" />
						<replacefilter token="@app.server.weblogic.dir.windows.double.slash@" value="${app.server.weblogic.dir.windows.double.slash}" />
						<replacefilter token="@app.server.weblogic.dir.windows.escaped@" value="${app.server.weblogic.dir.windows.escaped}" />
						<replacefilter token="@env.COMPUTERNAME@" value="${env.COMPUTERNAME}" />
						<replacefilter token="@env.JAVA_HOME@" value="${env.JAVA_HOME}" />
					</replace>
				</then>
			</elseif>
		</if>
	</target>

	<target name="unzip-websphere">
		<if>
			<and>
				<not>
					<available file="${app.server.parent.dir}/${app.server.websphere.installation.manager.zip.name.linux}" />
				</not>
				<os family="unix" />
			</and>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<fail>
.

Please download ${app.server.websphere.installation.manager.zip.name.linux} from ${app.server.websphere.installation.manager.zip.url}
and put it in ${app.server.parent.dir}. Then rerun this task.
				</fail>
			</then>
			<elseif>
				<and>
					<not>
						<available file="${app.server.parent.dir}/${app.server.websphere.installation.manager.zip.name.windows}" />
					</not>
					<os family="windows" />
				</and>
				<then>
					<mkdir dir="${app.server.parent.dir}" />

					<fail>
.

Please download ${app.server.websphere.installation.manager.zip.name.windows} from ${app.server.websphere.installation.manager.zip.url}
and put it in ${app.server.parent.dir}. Then rerun this task.
					</fail>
				</then>
			</elseif>
		</if>

		<for list="${app.server.websphere.repo.zip.names}" param="app.server.websphere.repo.zip.name">
			<sequential>
				<if>
					<not>
						<available file="${app.server.parent.dir}/@{app.server.websphere.repo.zip.name}" />
					</not>
					<then>
						<mkdir dir="${app.server.parent.dir}" />

						<fail>
.

Please download @{app.server.websphere.repo.zip.name} from ${app.server.websphere.zip.url}
and put it in ${app.server.parent.dir}. Then rerun this task.
						</fail>
					</then>
				</if>
			</sequential>
		</for>

		<for list="${app.server.websphere.fix.pack.jdk.zip.names}" param="app.server.websphere.fix.pack.jdk.zip.name">
			<sequential>
				<if>
					<not>
						<available file="${app.server.parent.dir}/@{app.server.websphere.fix.pack.jdk.zip.name}" />
					</not>
					<then>
						<mkdir dir="${app.server.parent.dir}" />

						<fail>
.

Please download @{app.server.websphere.fix.pack.jdk.zip.name} from ${app.server.websphere.fix.pack.zip.url}
and put it in ${app.server.parent.dir}. Then rerun this task.
						</fail>
					</then>
				</if>
			</sequential>
		</for>

		<for list="${app.server.websphere.fix.pack.was.zip.names}" param="app.server.websphere.fix.pack.was.zip.name">
			<sequential>
				<if>
					<not>
						<available file="${app.server.parent.dir}/@{app.server.websphere.fix.pack.was.zip.name}" />
					</not>
					<then>
						<mkdir dir="${app.server.parent.dir}" />

						<fail>
.

Please download @{app.server.websphere.fix.pack.was.zip.name} from ${app.server.websphere.fix.pack.zip.url}
and put it in ${app.server.parent.dir}. Then rerun this task.
						</fail>
					</then>
				</if>
			</sequential>
		</for>

		<delete dir="${app.server.websphere.dir}" />

		<echo>Installing installation manager. This may take a few minutes.</echo>

		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<if>
			<os family="unix" />
			<then>
				<unzip
					dest="${tstamp.value}/was_im"
					src="${app.server.parent.dir}/${app.server.websphere.installation.manager.zip.name.linux}"
				/>

				<chmod perm="a+x">
					<fileset dir="${tstamp.value}/was_im">
						<include name="installc" />
						<include name="**/jre/bin/java" />
					</fileset>
				</chmod>

				<exec dir="${tstamp.value}/was_im" executable="sh">
					<arg value="-c" />
					<arg value="./installc -acceptLicense" />
				</exec>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<unzip
						dest="${tstamp.value}/was_im"
						src="${app.server.parent.dir}/${app.server.websphere.installation.manager.zip.name.windows}"
					/>

					<exec dir="${tstamp.value}/was_im" executable="cmd.exe">
						<arg value="/c" />
						<arg value="installc.exe -acceptLicense" />
					</exec>
				</then>
			</elseif>
		</if>

		<delete dir="${tstamp.value}" />

		<echo>Installing application server. This may take a few minutes.</echo>

		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<for list="${app.server.websphere.repo.zip.names}" param="app.server.websphere.repo.zip.name">
			<sequential>
				<unzip
					dest="${tstamp.value}/was"
					src="${app.server.parent.dir}/@{app.server.websphere.repo.zip.name}"
				/>
			</sequential>
		</for>

		<echoxml file="${tstamp.value}/was/liferay-responseFile.xml">
			<agent-input clean="true" temporary="false">

			<install modify="false">
			 	<offering
			  		id='com.ibm.websphere.DEVELOPERSILAN.v85'
			  		profile='IBM Websphere 8.5.5.0'>
			  	</offering>
			</install>

			<profile
				id='IBM Websphere 8.5.5.0'
				installLocation='${app.server.websphere.dir}'>
			</profile>

			<server>
				<repository location="${project.dir}/${tstamp.value}/was/repository.config" />
			</server>

			</agent-input>
		</echoxml>

		<if>
			<os family="unix" />
			<then>
				<chmod file="/opt/IBM/InstallationManager/eclipse/tools/imcl" perm="a+x" />

				<exec dir="/opt/IBM/InstallationManager/eclipse/tools" executable="sh">
					<arg value="-c" />
					<arg value="./imcl input ${project.dir}/${tstamp.value}/was/liferay-responseFile.xml -acceptLicense" />
				</exec>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<exec dir="C:/Program Files/IBM/Installation Manager/eclipse/tools" executable="cmd.exe">
						<arg value="/c" />
						<arg value="imcl input ${project.dir}/${tstamp.value}/was/liferay-responseFile.xml -acceptLicense" />
					</exec>
				</then>
			</elseif>
		</if>

		<delete dir="${tstamp.value}" />

		<echo file="${app.server.websphere.dir}/liferay-portdef.props">
			WC_defaulthost=8080
		</echo>

		<echo file="${app.server.websphere.dir}/liferay-responsefile.txt">
			create
			cellName=liferay-cell
			enableAdminSecurity=false
			enableService=false
			isDefault=true
			isDeveloperServer=true
			nodeName=liferay-node
			omitAction=deployAdminConsole,defaultAppDeployAndConfig,samplesInstallAndConfig
			portsFile=${app.server.websphere.dir}/liferay-portdef.props
			profileName=liferay
			profilePath=${app.server.websphere.dir}/profiles/liferay
			templatePath=${app.server.websphere.dir}/profileTemplates/default
			winserviceCheck=false
		</echo>

		<echo>Creating profile. This may take a few minutes.</echo>

		<if>
			<os family="unix" />
			<then>
				<chmod file="${app.server.websphere.dir}/bin/manageprofiles.sh" perm="a+x" />

				<exec dir="${app.server.websphere.dir}/bin" executable="sh">
					<arg value="-c" />
					<arg value="./manageprofiles.sh -response ${app.server.websphere.dir}/liferay-responsefile.txt" />
				</exec>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<exec dir="${app.server.websphere.dir}/bin" executable="cmd.exe">
						<arg value="/c" />
						<arg value="manageprofiles.bat -response ${app.server.websphere.dir}/liferay-responsefile.txt" />
					</exec>
				</then>
			</elseif>
		</if>

		<delete failonerror="false" file="${app.server.websphere.dir}/liferay-portdef.props" />
		<delete failonerror="false" file="${app.server.websphere.dir}/liferay-responsefile.txt" />

		<replace file="${app.server.websphere.instance.dir}/config/cells/liferay-cell/nodes/liferay-node/servers/server1/server.xml">
			<replacetoken><![CDATA[disableJIT="false">]]></replacetoken>
			<replacevalue><![CDATA[disableJIT="false" maximumHeapSize="1024">]]></replacevalue>
		</replace>

		<echo>Installing fix pack. This may take a few minutes</echo>

		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<for list="${app.server.websphere.fix.pack.was.zip.names}" param="app.server.websphere.fix.pack.was.zip.name">
			<sequential>
				<unzip
					dest="${tstamp.value}/was_fixpack"
					src="${app.server.parent.dir}/@{app.server.websphere.fix.pack.was.zip.name}"
				/>
			</sequential>
		</for>

		<for list="${app.server.websphere.fix.pack.jdk.zip.names}" param="app.server.websphere.fix.pack.jdk.zip.name">
			<sequential>
				<unzip
					dest="${tstamp.value}/was_fixpack_jdk"
					src="${app.server.parent.dir}/@{app.server.websphere.fix.pack.jdk.zip.name}"
				/>
			</sequential>
		</for>

		<echoxml file="${tstamp.value}/was_fixpack/liferay-responseFile.xml">
			<agent-input clean="true" temporary="false">

			<install modify="false">
			 	<offering
			  		id='com.ibm.websphere.DEVELOPERSILAN.v85'
			  		profile='IBM Websphere 8.5.5.0'>
			  	</offering>

			 	<offering
			  		id='com.ibm.websphere.IBMJAVA.v80'
			  		profile='IBM Websphere 8.5.5.0'>
			  	</offering>
			</install>

			<profile
				id='IBM Websphere 8.5.5.0'
				installLocation='${app.server.websphere.dir}'>
			</profile>

			<server>
				<repository location="${project.dir}/${tstamp.value}/was_fixpack/repository.config" />
				<repository location="${project.dir}/${tstamp.value}/was_fixpack_jdk/repository.config" />
			</server>

			</agent-input>
		</echoxml>

		<if>
			<os family="unix" />
			<then>
				<chmod file="/opt/IBM/InstallationManager/eclipse/tools/imcl" perm="a+x" />

				<exec dir="/opt/IBM/InstallationManager/eclipse/tools" executable="sh">
					<arg value="-c" />
					<arg value="./imcl input ${project.dir}/${tstamp.value}/was_fixpack/liferay-responseFile.xml -acceptLicense" />
				</exec>

				<chmod file="${app.server.websphere.dir}/bin/managesdk.sh" perm="a+x" />

				<exec dir="${app.server.websphere.dir}/bin" executable="sh">
					<arg value="-c" />
					<arg value="./managesdk.sh -enableProfileAll -sdkName 1.8_64 -enableServers" />
				</exec>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<exec dir="C:/Program Files/IBM/Installation Manager/eclipse/tools" executable="cmd.exe">
						<arg value="/c" />
						<arg value="imcl input ${project.dir}/${tstamp.value}/was_fixpack/liferay-responseFile.xml -acceptLicense" />
					</exec>

					<exec dir="${app.server.websphere.dir}/bin" executable="cmd.exe">
						<arg value="/c" />
						<arg value="managesdk.bat -enableProfileAll -sdkName 1.8_64 -enableServers" />
					</exec>
				</then>
			</elseif>
		</if>

		<delete dir="${tstamp.value}" />

		<replace file="${app.server.websphere.instance.dir}/config/cells/liferay-cell/cell.xml">
			<replacetoken><![CDATA[<secureSessionCookie xmi:id="SecureSessionCookie_1" cookieDomain="*" cookieName="JSESSIONID" cookiePath="/"/>]]></replacetoken>
			<replacevalue><![CDATA[]]></replacevalue>
		</replace>
	</target>

	<target name="unzip-websphere-custom">
		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.websphere.custom.zip.name}" />
			</not>
			<then>
				<trycatch>
					<try>
						<mkdir dir="${app.server.parent.dir}" />

						<mirrors-get
							dest="${app.server.parent.dir}/${app.server.websphere.custom.zip.name}"
							src="http://mirrors/files.liferay.com/private/apps/ibm/websphere/8.5.5/${app.server.websphere.custom.zip.name}"
							verbose="true"
						/>
					</try>
					<catch>
						<fail>
.

Please download the Websphere custom zip file from
http://mirrors/files.liferay.com/private/apps/ibm/websphere/8.5.5 and
place it here: ${app.server.parent.dir}/${app.server.websphere.custom.zip.name}. Then rerun
this task.
						</fail>
					</catch>
				</trycatch>
			</then>
		</if>

		<delete dir="${app.server.websphere.dir}" />

		<unzip
			dest="${app.server.websphere.dir}"
			src="${app.server.parent.dir}/${app.server.websphere.custom.zip.name}"
		/>

		<if>
			<os family="windows" />
			<then>
				<propertyregex
					input="${app.server.websphere.dir.windows}"
					property="app.server.websphere.dir.windows.double.slash"
					regexp="\\"
					replace="\\\\\\\\"
				/>

				<propertyregex
					input="${app.server.websphere.dir.windows.double.slash}"
					property="app.server.websphere.dir.windows.escaped"
					regexp=":"
					replace="\\\\:"
				/>

				<replace
					dir="${app.server.websphere.dir}"
					includes="**/*.bat,**/*.js,**/*.metadata,**/*.properties,**/*.props,**/*.txt,**/*.xml"
				>
					<replacefilter token="@app.server.websphere.dir@" value="${app.server.websphere.dir}" />
					<replacefilter token="@app.server.websphere.dir.windows@" value="${app.server.websphere.dir.windows}" />
					<replacefilter token="@app.server.websphere.dir.windows.escaped@" value="${app.server.websphere.dir.windows.escaped}" />
				</replace>
			</then>
		</if>
	</target>

	<target name="unzip-wildfly">
		<delete dir="${app.server.wildfly.dir}" />

		<if>
			<not>
				<available file="${app.server.parent.dir}/${app.server.wildfly.zip.name}" />
			</not>
			<then>
				<mkdir dir="${app.server.parent.dir}" />

				<mirrors-get
					dest="${app.server.parent.dir}/${app.server.wildfly.zip.name}"
					src="${app.server.wildfly.zip.url}"
					verbose="true"
				/>
			</then>
		</if>

		<unzip
			dest="${app.server.parent.dir}"
			src="${app.server.parent.dir}/${app.server.wildfly.zip.name}"
		>
			<mapper
				type="glob"
				from="wildfly-${app.server.wildfly.version}.Final/*"
				to="wildfly-${app.server.wildfly.version}/*"
			/>
		</unzip>

		<property name="app.server.wildfly.module.file" value="${app.server.wildfly.dir}/modules/system/layers/base/sun/jdk/main/module.xml" />

		<replace file="${app.server.wildfly.module.file}">
			<replacetoken><![CDATA[<paths>]]></replacetoken>
			<replacevalue>
				<![CDATA[
					<paths>
						<path name="com/sun/crypto" />
						<path name="com/sun/crypto/provider" />
						<path name="com/sun/image/codec/jpeg" />
						<path name="com/sun/org/apache/xml/internal/resolver" />
						<path name="com/sun/org/apache/xml/internal/resolver/tools" />
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<extension module="org.jboss.as.weld"/>]]></replacetoken>
			<replacevalue></replacevalue>
		</replace>

		<replace file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<subsystem xmlns="urn:jboss:domain:weld:2.0"/>]]></replacetoken>
			<replacevalue></replacevalue>
		</replace>

		<replace file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<subsystem xmlns="urn:jboss:domain:weld:3.0"/>]]></replacetoken>
			<replacevalue></replacevalue>
		</replace>

		<replace file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[</extensions>]]></replacetoken>
			<replacevalue>
				<![CDATA[
					</extensions>
						<system-properties>
							<property name="org.apache.catalina.connector.URI_ENCODING" value="UTF-8" />
							<property name="org.apache.catalina.connector.USE_BODY_ENCODING_FOR_QUERY_STRING" value="true" />
						</system-properties>
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<deployment-scanner ]]></replacetoken>
			<replacevalue><![CDATA[<deployment-scanner deployment-timeout="360" ]]></replacevalue>
		</replace>

		<replace file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<security-domains>]]></replacetoken>
			<replacevalue>
				<![CDATA[
					<security-domains>
						<security-domain name="PortalRealm">
							<authentication>
								<login-module code="com.liferay.portal.security.jaas.PortalLoginModule" flag="required" />
							</authentication>
						</security-domain>
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml">
			<replacetoken><![CDATA[<location name="/" handler="welcome-content"/>]]></replacetoken>
			<replacevalue></replacevalue>
		</replace>

		<replaceregexp
			file="${app.server.wildfly.dir}/standalone/configuration/standalone.xml"
			match=" *&lt;handlers>\r?\n *&lt;file name=&quot;welcome-content&quot; path=&quot;\$\{jboss\.home\.dir}\/welcome-content&quot;\/>\r?\n *&lt;\/handlers>"
			replace=""
		/>

		<echo file="${app.server.wildfly.bin.dir}/server.policy">
			grant {
				permission java.security.AllPermission;
			};
		</echo>

		<replace file="${app.server.wildfly.bin.dir}/standalone.conf">
			<replacetoken><![CDATA[JAVA_OPTS="-Xms64m -Xmx512m -XX:MetaspaceSize=96M -XX:MaxMetaspaceSize=256m ]]></replacetoken>
			<replacevalue><![CDATA[JAVA_OPTS="]]></replacevalue>
		</replace>

		<if>
			<equals arg1="${java.security.manager.option}" arg2="" />
			<then>
				<var name="java.security.config" value="" />
			</then>
			<else>
				<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==${app.server.wildfly.dir}/bin/server.policy -Dwildfly.home.dir=${app.server.wildfly.dir}" />
			</else>
		</if>

		<echo append="true" file="${app.server.wildfly.bin.dir}/standalone.conf">
			<![CDATA[
				JAVA_OPTS="$JAVA_OPTS -Dfile.encoding=UTF-8 -Djava.net.preferIPv4Stack=true ${java.security.config} -Djboss.as.management.blocking.timeout=480 -Duser.timezone=GMT -Xmx1024m -XX:MaxMetaspaceSize=384m -XX:MetaspaceSize=200m"
			]]>
		</echo>

		<replace file="${app.server.wildfly.bin.dir}/standalone.conf.bat">
			<replacetoken><![CDATA[set "JAVA_OPTS=-Xms64M ]]></replacetoken>
			<replacevalue><![CDATA[rem set "JAVA_OPTS=-Xms64M ]]></replacevalue>
		</replace>

		<replace file="${app.server.wildfly.bin.dir}/standalone.conf.bat">
			<replacefilter token="@java.security.config@" value="${java.security.config}" />
			<replacetoken><![CDATA[:JAVA_OPTS_SET]]></replacetoken>
			<replacevalue>
				<![CDATA[
					set "JAVA_OPTS=%JAVA_OPTS% -Dfile.encoding=UTF-8 -Djava.net.preferIPv4Stack=true @java.security.config@ -Djboss.as.management.blocking.timeout=480 -Duser.timezone=GMT -Xmx1024m -XX:MaxMetaspaceSize=384m -XX:MetaspaceSize=200m"

					:JAVA_OPTS_SET
				]]>
			</replacevalue>
		</replace>

		<replace file="${app.server.wildfly.instance.dir}/configuration/standalone.xml">
			<replacetoken><![CDATA[<jsp-config/>]]></replacetoken>
			<replacevalue>
				<![CDATA[<jsp-config development="true" />]]>
			</replacevalue>
		</replace>

		<chmod perm="a+x">
			<fileset dir="${app.server.wildfly.bin.dir}">
				<include name="*.sh" />
			</fileset>
		</chmod>
	</target>

	<target name="update-java-security-tomcat">
		<if>
			<equals arg1="${java.security.manager.option}" arg2="" />
			<then>
				<var name="java.security.config" value="" />
			</then>
			<else>
				<if>
					<os family="windows" />
					<then>
						<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==%CATALINA_BASE%/conf/catalina.policy" />
					</then>
					<else>
						<var name="java.security.config" value="${java.security.manager.option} -Djava.security.policy==$CATALINA_BASE/conf/catalina.policy" />
					</else>
				</if>
			</else>
		</if>

		<copy
			file="tools/servers/tomcat/bin/setenv.bat"
			overwrite="true"
			tofile="${app.server.tomcat.bin.dir}/setenv.bat"
		>
			<filterset>
				<filter token="java.security.config" value="${java.security.config}" />
				<filter token="java.version" value="${jdk.windows.version}" />
			</filterset>
		</copy>

		<copy
			file="tools/servers/tomcat/bin/setenv.sh"
			overwrite="true"
			tofile="${app.server.tomcat.bin.dir}/setenv.sh"
		>
			<filterset>
				<filter token="java.security.config" value="${java.security.config}" />
			</filterset>
		</copy>

		<chmod perm="a+x">
			<fileset dir="${app.server.tomcat.bin.dir}">
				<include name="*.sh" />
			</fileset>
		</chmod>
	</target>

	<target name="update-plugins-includes">
		<echo file="${lp.plugins.dir}/build.${user.name}.properties">liferay.home=${liferay.home}

plugins.includes=</echo>

		<xmltask source="${lp.plugins.dir}/summary.xml">
			<call path="plugins-summary/plugin">
				<param name="plugins.includes.plugin.bundle" path="releng/bundle/text()" />
				<param default="" name="plugins.includes.plugin.dependent-apps" path="releng/dependent-apps/text()" />
				<param name="plugins.includes.plugin.marketplace" path="releng/marketplace/text()" />
				<param name="plugins.includes.plugin.name" path="artifact-id/text()" />
				<param name="plugins.includes.plugin.public" path="releng/public/text()" />
				<actions>
					<update-plugins-includes-plugin
						plugins.includes.plugin.bundle="@{plugins.includes.plugin.bundle}"
						plugins.includes.plugin.dependent-apps="@{plugins.includes.plugin.dependent-apps}"
						plugins.includes.plugin.marketplace="@{plugins.includes.plugin.marketplace}"
						plugins.includes.plugin.name="@{plugins.includes.plugin.name}"
						plugins.includes.plugin.public="@{plugins.includes.plugin.public}"
					/>
				</actions>
			</call>
		</xmltask>
	</target>

	<target name="zip-executable">
		<delete failonerror="false" file="dist/${zip.executable.file}-${lp.version}.zip" />

		<antelope:stringutil property="zip.executable.dir.beginindex" string="${zip.executable.dir}">
			<lastindexof string="/" />
		</antelope:stringutil>

		<math
			datatype="int"
			operand1="${zip.executable.dir.beginindex}"
			operand2="1"
			operation="+"
			result="zip.executable.dir.beginindex"
		/>

		<antelope:stringutil property="zip.executable.dir.name" string="${zip.executable.dir}">
			<substring beginindex="${zip.executable.dir.beginindex}" />
		</antelope:stringutil>

		<mkdir dir="dist" />

		<if>
			<available file="${zip.executable.dir}/../data" />
			<then>
				<zip
					destfile="dist/${zip.executable.file}-${lp.version}.zip"
				>
					<zipfileset
						dir="${zip.executable.dir}"
						excludes="**/*.sh"
						prefix="liferay-portal-${lp.version}/${zip.executable.dir.name}"
					/>
					<zipfileset
						dir="${zip.executable.dir}"
						filemode="744"
						includes="**/*.sh"
						prefix="liferay-portal-${lp.version}/${zip.executable.dir.name}"
					/>
					<zipfileset
						dir="${zip.executable.dir}/.."
						includes=".liferay-home"
						prefix="liferay-portal-${lp.version}"
					/>
					<zipfileset
						dir="${zip.executable.dir}/../data"
						prefix="liferay-portal-${lp.version}/data"
					/>
					<zipfileset
						dir="tools/zip_tmpl"
						prefix="liferay-portal-${lp.version}"
					/>
				</zip>

				<if>
					<available file="${zip.executable.dir}/../deploy" />
					<then>
						<zip
							destfile="dist/${zip.executable.file}-${lp.version}.zip"
							update="true"
						>
							<zipfileset
								dir="${zip.executable.dir}/../deploy"
								prefix="liferay-portal-${lp.version}/deploy"
							/>
						</zip>
					</then>
				</if>

				<if>
					<available file="${zip.executable.dir}/../osgi" />
					<then>
						<zip
							destfile="dist/${zip.executable.file}-${lp.version}.zip"
							update="true"
						>
							<zipfileset
								dir="${zip.executable.dir}/../osgi"
								prefix="liferay-portal-${lp.version}/osgi"
							/>
						</zip>
					</then>
				</if>

				<delete dir="${zip.executable.dir}/../patching-tool" />

				<if>
					<available file="${patching.tool.zip}" />
					<then>
						<unzip dest="${zip.executable.dir}/.." src="${patching.tool.zip}" />

						<if>
							<contains string="${zip.executable.dir}" substring="glassfish" />
							<then>
								<echo file="${zip.executable.dir}/../patching-tool/default.properties">
									global.lib.path=${zip.executable.dir}/domains/domain1/autodeploy/liferay-portal.war/WEB-INF/lib/ext/
									jdk.version=jdk6
									patching.mode=binary
									war.path=${zip.executable.dir}/domains/domain1/autodeploy/liferay-portal.war/
								</echo>
							</then>
							<else>
								<antcall target="exec-patching-tool">
									<param name="patching.tool.arg.line" value="auto-discovery" />
									<param name="patching.tool.dir" value="${zip.executable.dir}/../patching-tool" />
								</antcall>
							</else>
						</if>

						<delete>
							<fileset dir="${zip.executable.dir}/../patching-tool/logs" />
						</delete>

						<replace
							file="${zip.executable.dir}/../patching-tool/default.properties"
							token="${zip.executable.dir}"
							value="../${zip.executable.dir.name}"
						/>

						<zip
							destfile="dist/${zip.executable.file}-${lp.version}.zip"
							update="yes"
						>
							<zipfileset
								dir="${zip.executable.dir}/../patching-tool"
								excludes="**/*.sh"
								prefix="liferay-portal-${lp.version}/patching-tool"
							/>
							<zipfileset
								dir="${zip.executable.dir}/../patching-tool"
								filemode="744"
								includes="**/*.sh"
								prefix="liferay-portal-${lp.version}/patching-tool"
							/>
						</zip>
					</then>
				</if>

				<if>
					<available file="${zip.executable.dir}/../tools" />
					<then>
						<zip
							destfile="dist/${zip.executable.file}-${lp.version}.zip"
							update="true"
						>
							<zipfileset
								dir="${zip.executable.dir}/../tools"
								prefix="liferay-portal-${lp.version}/tools"
							/>
						</zip>
					</then>
				</if>

				<if>
					<available file="${zip.executable.dir}/../work" />
					<then>
						<zip
							destfile="dist/${zip.executable.file}-${lp.version}.zip"
							update="true"
						>
							<zipfileset
								dir="${zip.executable.dir}/../work"
								prefix="liferay-portal-${lp.version}/work"
							/>
						</zip>
					</then>
				</if>
			</then>
			<else>

				<!--
				Only used by when zipping Tcat admin and agent
				-->

				<zip
					destfile="dist/${zip.executable.file}-${lp.version}.zip"
				>
					<zipfileset
						dir="${zip.executable.dir}"
						excludes="**/*.sh"
						prefix="liferay-portal-${lp.version}/${zip.executable.dir.name}"
					/>
					<zipfileset
						dir="${zip.executable.dir}"
						filemode="744"
						includes="**/*.sh"
						prefix="liferay-portal-${lp.version}/${zip.executable.dir.name}"
					/>
				</zip>
			</else>
		</if>
	</target>

	<target name="zip-glassfish">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-glassfish" />
			<param name="zip.executable.dir" value="${app.server.glassfish.dir}" />
		</antcall>
	</target>

	<target name="zip-jboss">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jboss" />
			<param name="zip.executable.dir" value="${app.server.jboss.dir}" />
		</antcall>
	</target>

	<target name="zip-jetty">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jetty" />
			<param name="zip.executable.dir" value="${app.server.jetty.dir}" />
		</antcall>
	</target>

	<target name="zip-jonas">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jonas" />
			<param name="zip.executable.dir" value="${app.server.jonas.dir}" />
		</antcall>
	</target>

	<target name="zip-patching-tool">
		<if>
			<available file="${patching.tool.source.dir}" type="dir" />
			<then>
				<tstamp>
					<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
				</tstamp>

				<mkdir dir="${tstamp.value}/lib" />
				<mkdir dir="${tstamp.value}/logs" />
				<mkdir dir="${tstamp.value}/patches" />

				<copy todir="${tstamp.value}/lib">
					<fileset
						dir="${patching.tool.source.dir}/lib"
					/>
					<fileset
						dir="${patching.tool.source.dir}"
						includes="patching-tool.jar"
					/>
				</copy>

				<copy todir="${tstamp.value}">
					<fileset
						dir="${patching.tool.source.dir}/scripts"
					/>
				</copy>

				<zip destfile="dist/liferay-portal-patching-tool-${lp.version}.zip">
					<zipfileset
						dir="${tstamp.value}"
						excludes="patching-tool.sh"
						prefix="liferay-portal-patching-tool-${lp.version}"
					/>
					<zipfileset
						dir="${tstamp.value}"
						filemode="744"
						includes="patching-tool.sh"
						prefix="liferay-portal-patching-tool-${lp.version}"
					/>
				</zip>

				<delete dir="${tstamp.value}" />
			</then>
		</if>
	</target>

	<target name="zip-portal-client">
		<delete failonerror="false" file="dist/liferay-portal-client-${lp.version}.zip" />

		<zip destfile="dist/liferay-portal-client-${lp.version}.zip">
			<zipfileset
				dir="lib/development"
				includes="activation.jar,mail.jar"
				prefix="liferay-portal-client-${lp.version}"
			/>
			<zipfileset
				dir="lib/portal"
				includes="axis.jar,commons-discovery.jar,commons-logging.jar,jaxrpc.jar,portal-client.jar,saaj-api.jar,saaj-impl.jar,wsdl4j.jar"
				prefix="liferay-portal-client-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-portal-dependencies">
		<delete failonerror="false" file="dist/liferay-portal-dependencies-${lp.version}.zip" />

		<zip destfile="dist/liferay-portal-dependencies-${lp.version}.zip">
			<zipfileset
				dir="lib/development"
				includes="hsql.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
			<zipfileset
				dir="lib/global"
				includes="*.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
			<zipfileset
				dir="portal-kernel"
				includes="portal-kernel.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
			<zipfileset
				dir="tools/sdk/dist"
				includes="com.liferay.registry.api*.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-portal-tools">
		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<mkdir dir="${tstamp.value}" />

		<copy todir="${tstamp.value}">
			<fileset
				dir="${liferay.home}/tools"
			/>
		</copy>

		<zip destfile="dist/liferay-portal-tools-${lp.version}.zip">
			<zipfileset
				dir="${tstamp.value}"
				prefix="liferay-portal-tools-${lp.version}"
			/>
		</zip>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-portal-war">
		<antcall target="zip-portal-war-2.4" />
		<!--<antcall target="zip-portal-war-2.3" />
		<antcall target="zip-portal-war-2.4-with-dependencies" />
		<antcall target="zip-portal-war-2.3-with-dependencies" />-->
	</target>

	<target name="zip-portal-war-2.3">
		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<java
			classname="com.liferay.portal.tools.WebXML23Converter"
			classpathref="project.classpath"
			fork="true"
			maxmemory="128m"
			newenvironment="true"
		>
			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.Log4JLogger" />
			<arg value="${app.server.portal.dir}/WEB-INF/web.xml" />
			<arg value="${tstamp.value}/WEB-INF/web.xml" />
		</java>

		<delete failonerror="false" file="dist/liferay-portal-${lp.version}-servlet23.war" />

		<copy
			file="dist/liferay-portal-${lp.version}.war"
			tofile="dist/liferay-portal-${lp.version}-servlet23.war"
			overwrite="true"
		/>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}-servlet23.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-portal-war-2.3-with-dependencies">
		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<copy todir="${tstamp.value}/WEB-INF/lib">
			<fileset
				dir="${app.server.lib.global.dir}"
				includes="annotations.jar,portal-kernel.jar,portlet.jar"
			/>
		</copy>

		<delete failonerror="false" file="dist/liferay-portal-${lp.version}-servlet23-with-dependencies.war" />

		<copy
			file="dist/liferay-portal-${lp.version}-servlet23.war"
			tofile="dist/liferay-portal-${lp.version}-servlet23-with-dependencies.war"
			overwrite="true"
		/>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}-servlet23-with-dependencies.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-portal-war-2.4">
		<delete failonerror="false" file="dist/liferay-portal-${lp.version}.war" />

		<zip
			basedir="${app.server.portal.dir}"
			destfile="dist/liferay-portal-${lp.version}.war"
		/>

		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<!--
		LPS-3408
		-->

		<copy todir="${tstamp.value}/WEB-INF/lib">
			<fileset
				dir="lib/portal"
				includes="ccpp.jar"
			/>
		</copy>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-portal-war-2.4-with-dependencies">
		<tstamp>
			<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
		</tstamp>

		<copy todir="${tstamp.value}/WEB-INF/lib">
			<fileset
				dir="${app.server.lib.global.dir}"
				includes="annotations.jar,portal-kernel.jar,portlet.jar"
			/>
		</copy>

		<delete failonerror="false" file="dist/liferay-portal-${lp.version}-with-dependencies.war" />

		<copy
			file="dist/liferay-portal-${lp.version}.war"
			tofile="dist/liferay-portal-${lp.version}-with-dependencies.war"
			overwrite="true"
		/>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}-with-dependencies.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-resin">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-resin" />
			<param name="zip.executable.dir" value="${app.server.resin.dir}" />
		</antcall>
	</target>

	<target name="zip-sql">
		<delete failonerror="false" file="dist/liferay-portal-sql-${lp.version}.zip" />

		<zip destfile="dist/liferay-portal-sql-${lp.version}.zip">
			<zipfileset
				dir="sql"
				includes="**/*.sql"
				prefix="liferay-portal-sql-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-src">
		<delete failonerror="false" file="dist/liferay-portal-src-${lp.version}.zip" />

		<zip destfile="dist/liferay-portal-src-${lp.version}.zip">
			<zipfileset
				dir="${lp.source.dir}"
				excludes=".gradle/**,portal-web/test/com/**,portal-web/test-ant-templates/**"
				prefix="liferay-portal-src-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-tcat">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-tcat-admin" />
			<param name="zip.executable.dir" value="${app.server.tcat.dir}/admin" />
		</antcall>

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-tcat-agent" />
			<param name="zip.executable.dir" value="${app.server.tcat.dir}/agent" />
		</antcall>
	</target>

	<target name="zip-tomcat">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-tomcat" />
			<param name="zip.executable.dir" value="${app.server.tomcat.dir}" />
		</antcall>
	</target>

	<target name="zip-weblogic-custom">
		<delete>
			<fileset dir="${app.server.weblogic.dir}/cfgtoollogs" includes="opatchauto/**" />
			<fileset dir="${app.server.weblogic.dir}/cfgtoollogs" includes="oui/**" />
		</delete>

		<if>
			<os family="unix" />
			<then>
				<replace
					dir="${app.server.weblogic.dir}"
					includes="**/*.cmd,**/*.domains,**/*.properties,**/*.sh,**/*.xml"
				>
					<replacefilter token="${env.JAVA_HOME}" value="@env.JAVA_HOME@" />
				</replace>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<pathconvert property="app.server.parent.dir.windows" targetos="windows">
						<path location="${app.server.parent.dir}" />
					</pathconvert>

					<propertyregex
						input="${app.server.parent.dir.windows}"
						property="app.server.parent.dir.windows.double.slash"
						regexp="\\"
						replace="\\\\\\\\"
					/>

					<propertyregex
						input="${app.server.parent.dir.windows.double.slash}"
						property="app.server.parent.dir.windows.escaped"
						regexp=":"
						replace="\\\\:"
					/>

					<pathconvert property="app.server.weblogic.dir.windows" targetos="windows">
						<path location="${app.server.weblogic.dir}" />
					</pathconvert>

					<propertyregex
						input="${app.server.weblogic.dir.windows}"
						property="app.server.weblogic.dir.windows.double.slash"
						regexp="\\"
						replace="\\\\\\\\"
					/>

					<propertyregex
						input="${app.server.weblogic.dir.windows.double.slash}"
						property="app.server.weblogic.dir.windows.escaped"
						regexp=":"
						replace="\\\\:"
					/>

					<antelope:stringutil property="env.COMPUTERNAME.lowercase" string="${env.COMPUTERNAME}">
						<antelope:lowercase />
					</antelope:stringutil>

					<replace
						dir="${app.server.weblogic.dir}"
						includes="**/*.cmd,**/*.domains,**/*.properties,**/*.sh,**/*.xml"
					>
						<replacefilter token="${app.server.parent.dir}/WEBLOG~1.1" value="@app.server.weblogic.dir@" />
						<replacefilter token="${app.server.parent.dir}/WEBLOG~1.6" value="@app.server.weblogic.dir@" />
						<replacefilter token="${app.server.parent.dir.windows}\WEBLOG~1.1" value="@app.server.weblogic.dir.windows@" />
						<replacefilter token="${app.server.parent.dir.windows}\WEBLOG~1.6" value="@app.server.weblogic.dir.windows@" />
						<replacefilter token="${app.server.parent.dir.windows.double.slash}\\WEBLOG~1.1" value="@app.server.weblogic.dir.windows.double.slash@" />
						<replacefilter token="${app.server.parent.dir.windows.double.slash}\\WEBLOG~1.6" value="@app.server.weblogic.dir.windows.double.slash@" />
						<replacefilter token="${app.server.parent.dir.windows.escaped}\\WEBLOG~1.1" value="@app.server.weblogic.dir.windows.escaped@" />
						<replacefilter token="${app.server.parent.dir.windows.escaped}\\WEBLOG~1.6" value="@app.server.weblogic.dir.windows.escaped@" />
						<replacefilter token="${app.server.weblogic.dir}" value="@app.server.weblogic.dir@" />
						<replacefilter token="${app.server.weblogic.dir.windows}" value="@app.server.weblogic.dir.windows@" />
						<replacefilter token="${app.server.weblogic.dir.windows.escaped}" value="@app.server.weblogic.dir.windows.escaped@" />
						<replacefilter token="${env.COMPUTERNAME.lowercase}" value="@env.COMPUTERNAME@" />
						<replacefilter token="${env.JAVA_HOME}" value="@env.JAVA_HOME@" />
					</replace>
				</then>
			</elseif>
		</if>

		<zip
			destfile="${app.server.parent.dir}/${app.server.weblogic.custom.zip.name}"
		>
			<zipfileset
				dir="${app.server.weblogic.dir}"
			/>
		</zip>
	</target>

	<target name="zip-websphere-custom">
		<delete>
			<fileset dir="${app.server.websphere.dir}" includes="logs/**" />
		</delete>

		<if>
			<os family="windows" />
			<then>
				<pathconvert property="app.server.websphere.dir.windows" targetos="windows">
					<path location="${app.server.websphere.dir}" />
				</pathconvert>

				<propertyregex
					input="${app.server.websphere.dir.windows}"
					property="app.server.websphere.dir.windows.double.slash"
					regexp="\\"
					replace="\\\\\\\\"
				/>

				<propertyregex
					input="${app.server.websphere.dir.windows.double.slash}"
					property="app.server.websphere.dir.windows.escaped"
					regexp=":"
					replace="\\\\:"
				/>

				<replace
					dir="${app.server.websphere.dir}"
					includes="**/*.bat,**/*.js,**/*.metadata,**/*.properties,**/*.props,**/*.txt,**/*.xml"
				>
					<replacefilter token="${app.server.websphere.dir}" value="@app.server.websphere.dir@" />
					<replacefilter token="${app.server.websphere.dir.windows}" value="@app.server.websphere.dir.windows@" />
					<replacefilter token="${app.server.websphere.dir.windows.escaped}" value="@app.server.websphere.dir.windows.escaped@" />
				</replace>
			</then>
		</if>

		<zip
			destfile="${app.server.parent.dir}/${app.server.websphere.custom.zip.name}"
		>
			<zipfileset
				dir="${app.server.websphere.dir}"
			/>
		</zip>
	</target>

	<target name="zip-wildfly">
		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-wildfly" />
			<param name="zip.executable.dir" value="${app.server.wildfly.dir}" />
		</antcall>
	</target>
</project>